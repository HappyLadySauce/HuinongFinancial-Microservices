# å¾®æœåŠ¡æ²»ç†å®Œæ•´å®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [é…ç½®ä¼˜åŒ–](#é…ç½®ä¼˜åŒ–)
3. [ç†”æ–­å™¨å®æ–½](#ç†”æ–­å™¨å®æ–½)
4. [éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•](#éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•)
5. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
6. [ç›‘æ§å’Œå‘Šè­¦](#ç›‘æ§å’Œå‘Šè­¦)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†ä¸ºHuinongFinancial-Microservicesé¡¹ç›®å…¨é¢å®æ–½æœåŠ¡æ²»ç†çš„å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ç†”æ–­å™¨ã€é‡è¯•æœºåˆ¶ã€è¶…æ—¶æ§åˆ¶ã€ç›‘æ§ç­‰åŠŸèƒ½ã€‚

### ğŸ¯ æ²»ç†ç›®æ ‡

- **å¯ç”¨æ€§**: é€šè¿‡ç†”æ–­å™¨é˜²æ­¢çº§è”æ•…éšœ
- **å¥å£®æ€§**: é€šè¿‡æ‡’åŠ è½½å’Œé‡è¯•æé«˜å¯åŠ¨æˆåŠŸç‡
- **å¯è§‚æµ‹æ€§**: é€šè¿‡ç›‘æ§å’Œæ—¥å¿—åŠæ—¶å‘ç°é—®é¢˜
- **æ€§èƒ½**: é€šè¿‡è¶…æ—¶æ§åˆ¶å’Œè¿æ¥æ± ä¼˜åŒ–å“åº”æ—¶é—´

## é…ç½®ä¼˜åŒ–

### âœ… å·²å®Œæˆçš„é…ç½®ä¼˜åŒ–

æ‰€æœ‰6ä¸ªæ¨¡å—çš„RPCå®¢æˆ·ç«¯é…ç½®å·²ä¼˜åŒ–ï¼š

```yaml
# ç¤ºä¾‹é…ç½® - å·²åº”ç”¨åˆ°æ‰€æœ‰æ¨¡å—
AppUserRpc:
  Target: consul://consul.huinong.internal/appuserrpc.rpc
  LazyInit: true        # æ‡’åŠ è½½ï¼šé¿å…å¯åŠ¨æ—¶å› ä¾èµ–æœåŠ¡æœªå°±ç»ªè€Œå¤±è´¥
  DialTimeout: 10s      # è¿æ¥è¶…æ—¶ï¼šç»™ä¾èµ–æœåŠ¡æ›´å¤šå¯åŠ¨æ—¶é—´
  Timeout: 5s           # è°ƒç”¨è¶…æ—¶ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…
  KeepaliveTime: 30s    # ä¿æ´»æ—¶é—´ï¼šå‡å°‘è¿æ¥é‡å»ºå¼€é”€
  NonBlock: true        # éé˜»å¡ï¼šå¯åŠ¨æ—¶ä¸ç­‰å¾…è¿æ¥å»ºç«‹
```

**è¦†ç›–æ¨¡å—**ï¼š
- âœ… appuser (API + RPC)
- âœ… oauser (API + RPC)  
- âœ… loanproduct (API + RPC)
- âœ… leaseproduct (API + RPC)
- âœ… loan (API + RPC)
- âœ… lease (API + RPC)

## ç†”æ–­å™¨å®æ–½

### âœ… å·²å®Œæˆçš„ç†”æ–­å™¨å·¥å…·

**å¢å¼ºç‰ˆç†”æ–­å™¨å·¥å…·**: `app/common/breaker/rpc_breaker.go`

æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
- `DoWithBreakerResultAcceptable` - æ¨èä½¿ç”¨ï¼Œæ”¯æŒè‡ªå®šä¹‰é”™è¯¯åˆ¤æ–­
- `DoWithBreakerAndRetry` - å¸¦é‡è¯•çš„ç†”æ–­å™¨è°ƒç”¨
- `IsAcceptableError` - æ™ºèƒ½é”™è¯¯åˆ†ç±»
- `CreateFriendlyErrorMessage` - å‹å¥½é”™è¯¯ä¿¡æ¯ç”Ÿæˆ

### âœ… å·²å®Œæˆçš„ServiceContextæ”¹é€ 

æ‰€æœ‰æ¨¡å—çš„ServiceContextå·²æ·»åŠ ç†”æ–­å™¨æ”¯æŒï¼š

```go
type ServiceContext struct {
    Config    config.Config
    LoanRpc   loanclient.Loan
    
    // ç†”æ–­å™¨å®¢æˆ·ç«¯
    LoanRpcBreaker *breaker.RpcBreakerClient
}
```

### ğŸ”„ ç†”æ–­å™¨å®æ–½çŠ¶æ€

#### APIå±‚ â†’ RPCå±‚è°ƒç”¨

| æ¨¡å— | çŠ¶æ€ | ç¤ºä¾‹æ–‡ä»¶ |
|-----|------|---------|
| AppUser API â†’ AppUser RPC | âœ… éƒ¨åˆ†å®Œæˆ | `loginLogic.go`, `registerLogic.go` |
| OaUser API â†’ OaUser RPC | âŒ å¾…å®æ–½ | éœ€è¦å¤„ç†8ä¸ªLogicæ–‡ä»¶ |
| LoanProduct API â†’ LoanProduct RPC | âœ… éƒ¨åˆ†å®Œæˆ | `createLoanProductLogic.go` |
| LeaseProduct API â†’ LeaseProduct RPC | âŒ å¾…å®æ–½ | éœ€è¦å¤„ç†8ä¸ªLogicæ–‡ä»¶ |
| Loan API â†’ Loan RPC | âœ… éƒ¨åˆ†å®Œæˆ | `createLoanApplicationLogic.go`, `cancelMyLoanApplicationLogic.go` |
| Lease API â†’ Lease RPC | âœ… éƒ¨åˆ†å®Œæˆ | `createLeaseApplicationLogic.go` |

#### RPCå±‚ â†’ å…¶ä»–RPCå±‚è°ƒç”¨

| æ¨¡å— | ä¾èµ–æœåŠ¡ | çŠ¶æ€ | ç¤ºä¾‹æ–‡ä»¶ |
|-----|---------|------|---------|
| Loan RPC | AppUser RPC, LoanProduct RPC | âœ… éƒ¨åˆ†å®Œæˆ | `createloanapplicationlogic.go` |
| Lease RPC | AppUser RPC, LeaseProduct RPC | âœ… éƒ¨åˆ†å®Œæˆ | `createleaseapplicationlogic.go` |

## éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### ğŸš¨ ä¼˜å…ˆçº§1ï¼šå…³é”®ä¸šåŠ¡æµç¨‹

#### Loanæ¨¡å—
```
app/loan/cmd/api/internal/logic/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ approveLoanApplicationLogic.go âŒ
â”‚   â”œâ”€â”€ getLoanApplicationDetailLogic.go âŒ
â”‚   â”œâ”€â”€ listAllLoanApplicationsLogic.go âŒ
â”‚   â””â”€â”€ listLoanApprovalsLogic.go âŒ
â””â”€â”€ loan/
    â”œâ”€â”€ getMyLoanApplicationLogic.go âŒ
    â”œâ”€â”€ listMyLoanApplicationsLogic.go âŒ
    â””â”€â”€ updateMyLoanApplicationLogic.go âŒ
```

#### Leaseæ¨¡å—
```
app/lease/cmd/api/internal/logic/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ approveLeaseApplicationLogic.go âŒ
â”‚   â”œâ”€â”€ getLeaseApplicationDetailLogic.go âŒ
â”‚   â”œâ”€â”€ listAllLeaseApplicationsLogic.go âŒ
â”‚   â””â”€â”€ listLeaseApprovalsLogic.go âŒ
â””â”€â”€ lease/
    â”œâ”€â”€ cancelMyLeaseApplicationLogic.go âŒ
    â”œâ”€â”€ getMyLeaseApplicationLogic.go âŒ
    â”œâ”€â”€ listMyLeaseApplicationsLogic.go âŒ
    â””â”€â”€ updateMyLeaseApplicationLogic.go âŒ
```

### ğŸ”¶ ä¼˜å…ˆçº§2ï¼šç”¨æˆ·ç®¡ç†

#### AppUseræ¨¡å—
```
app/appuser/cmd/api/internal/logic/
â”œâ”€â”€ auth_jwt/
â”‚   â”œâ”€â”€ changePasswordLogic.go âŒ
â”‚   â””â”€â”€ logoutLogic.go âŒ
â””â”€â”€ info/
    â”œâ”€â”€ deleteUserLogic.go âŒ
    â”œâ”€â”€ getUserByPhoneLogic.go âŒ
    â””â”€â”€ updateUserInfoLogic.go âŒ
```

#### OaUseræ¨¡å—
```
app/oauser/cmd/api/internal/logic/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ loginLogic.go âŒ
â”‚   â””â”€â”€ registerLogic.go âŒ
â”œâ”€â”€ auth_jwt/
â”‚   â”œâ”€â”€ changePasswordLogic.go âŒ
â”‚   â””â”€â”€ logoutLogic.go âŒ
â””â”€â”€ info/
    â”œâ”€â”€ deleteUserLogic.go âŒ
    â”œâ”€â”€ getUserByPhoneLogic.go âŒ
    â”œâ”€â”€ updateUserInfoLogic.go âŒ
    â””â”€â”€ updateUserStatusLogic.go âŒ
```

### ğŸ”¶ ä¼˜å…ˆçº§3ï¼šäº§å“ç®¡ç†

#### LoanProductæ¨¡å—
```
app/loanproduct/cmd/api/internal/logic/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ deleteLoanProductLogic.go âŒ
â”‚   â”œâ”€â”€ getLoanProductDetailLogic.go âŒ
â”‚   â”œâ”€â”€ listAllLoanProductsLogic.go âŒ
â”‚   â”œâ”€â”€ updateLoanProductLogic.go âŒ
â”‚   â””â”€â”€ updateProductStatusLogic.go âŒ
â””â”€â”€ product/
    â”œâ”€â”€ getLoanProductLogic.go âŒ
    â””â”€â”€ listLoanProductsLogic.go âŒ
```

#### LeaseProductæ¨¡å—
```
app/leaseproduct/cmd/api/internal/logic/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ createLeaseProductLogic.go âŒ
â”‚   â”œâ”€â”€ deleteLeaseProductLogic.go âŒ
â”‚   â”œâ”€â”€ getLeaseProductDetailLogic.go âŒ
â”‚   â”œâ”€â”€ listAllLeaseProductsLogic.go âŒ
â”‚   â””â”€â”€ updateLeaseProductLogic.go âŒ
â””â”€â”€ product/
    â”œâ”€â”€ checkInventoryAvailabilityLogic.go âŒ
    â”œâ”€â”€ getLeaseProductLogic.go âŒ
    â””â”€â”€ listLeaseProductsLogic.go âŒ
```

## å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šå‡†å¤‡å·¥ä½œ

```bash
# 1. ç¡®ä¿ç†”æ–­å™¨å·¥å…·å·²å°±ç»ª
ls app/common/breaker/rpc_breaker.go

# 2. è¿è¡Œæ‰¹é‡å¤„ç†è„šæœ¬ï¼ˆæ·»åŠ importï¼‰
./scripts/add_circuit_breaker.sh

# 3. éªŒè¯é…ç½®æ–‡ä»¶å·²ä¼˜åŒ–
grep -r "LazyInit: true" app/*/cmd/*/etc/
```

### ç¬¬2æ­¥ï¼šæŒ‰ä¼˜å…ˆçº§å®æ–½ç†”æ–­å™¨

#### ä¼˜å…ˆçº§1ï¼šå…³é”®ä¸šåŠ¡æµç¨‹

**æ¨¡å¼Aï¼šAPIå±‚è°ƒç”¨RPCå±‚**
```go
// åŸå§‹ä»£ç 
rpcResp, err := l.svcCtx.LoanRpc.GetLoanApplication(l.ctx, &loanclient.GetLoanApplicationReq{
    ApplicationId: applicationId,
})

// ç†”æ–­å™¨ä»£ç 
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.GetLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.GetLoanApplication(l.ctx, &loanclient.GetLoanApplicationReq{
        ApplicationId: applicationId,
    })
}, breaker.IsAcceptableError)
```

**æ¨¡å¼Bï¼šRPCå±‚è°ƒç”¨å…¶ä»–RPC**
```go
// åŸå§‹ä»£ç 
userResp, err := l.svcCtx.AppUserClient.GetUserById(l.ctx, &appuserclient.GetUserByIdReq{
    UserId: in.UserId,
})

// ç†”æ–­å™¨ä»£ç 
userResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuserclient.GetUserInfoResp, error) {
    return l.svcCtx.AppUserClient.GetUserById(l.ctx, &appuserclient.GetUserByIdReq{
        UserId: in.UserId,
    })
}, breaker.IsAcceptableError)
```

### ç¬¬3æ­¥ï¼šé‡è¯•æœºåˆ¶å®æ–½

å¯¹äºå…³é”®ä¸šåŠ¡ï¼Œå¯ä»¥æ·»åŠ é‡è¯•ï¼š

```go
// å¸¦é‡è¯•çš„ç†”æ–­å™¨è°ƒç”¨
rpcResp, err := breaker.DoWithBreakerAndRetry(l.ctx, "loan-rpc", func() (*loanclient.GetLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.GetLoanApplication(l.ctx, &loanclient.GetLoanApplicationReq{
        ApplicationId: applicationId,
    })
}, 3, time.Second) // æœ€å¤šé‡è¯•3æ¬¡ï¼Œæ¯æ¬¡é—´éš”1ç§’
```

### ç¬¬4æ­¥ï¼šæµ‹è¯•éªŒè¯

```bash
# 1. ç¼–è¯‘æ£€æŸ¥
cd app/loan/cmd/api && go build

# 2. æµ‹è¯•æœåŠ¡å¯åŠ¨ï¼ˆæ¨¡æ‹Ÿä¾èµ–æœåŠ¡æœªå¯åŠ¨ï¼‰
# æœåŠ¡åº”è¯¥èƒ½æ­£å¸¸å¯åŠ¨ï¼Œä¸ä¼šå› ä¸ºä¾èµ–æœåŠ¡æœªå°±ç»ªè€Œå¤±è´¥

# 3. æµ‹è¯•ç†”æ–­å™¨
# åœæ­¢ä¾èµ–æœåŠ¡ï¼Œè§‚å¯ŸAPIè°ƒç”¨æ˜¯å¦å¿«é€Ÿå¤±è´¥å¹¶è¿”å›å‹å¥½é”™è¯¯
```

## ç›‘æ§å’Œå‘Šè­¦

### æ¨èçš„ç›‘æ§æŒ‡æ ‡

```go
// åœ¨å…³é”®è°ƒç”¨å‰åæ·»åŠ ç›‘æ§
start := time.Now()
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.GetLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.GetLoanApplication(l.ctx, &loanclient.GetLoanApplicationReq{
        ApplicationId: applicationId,
    })
}, breaker.IsAcceptableError)

// è®°å½•è°ƒç”¨æ—¶é—´å’Œç»“æœ
logx.WithContext(l.ctx).Infof("RPCè°ƒç”¨è€—æ—¶: %v, æˆåŠŸ: %v", time.Since(start), err == nil)
```

### å…³é”®ç›‘æ§ç‚¹

1. **ç†”æ–­å™¨çŠ¶æ€**: ç›‘æ§ç†”æ–­å™¨å¼€å¯/å…³é—­çŠ¶æ€
2. **è°ƒç”¨å»¶è¿Ÿ**: ç›‘æ§RPCè°ƒç”¨å¹³å‡å“åº”æ—¶é—´
3. **é”™è¯¯ç‡**: ç›‘æ§ä¸šåŠ¡é”™è¯¯vsç³»ç»Ÿé”™è¯¯æ¯”ä¾‹
4. **é‡è¯•æ¬¡æ•°**: ç›‘æ§é‡è¯•é¢‘ç‡å’ŒæˆåŠŸç‡

## æœ€ä½³å®è·µ

### ğŸ¯ é”™è¯¯å¤„ç†ç­–ç•¥

```go
// 1. ä¸šåŠ¡é”™è¯¯ï¼šä¸é‡è¯•ï¼Œä¸ç†”æ–­ï¼Œç›´æ¥è¿”å›
if err != nil && breaker.IsBusinessError(err) {
    return nil, err
}

// 2. ç³»ç»Ÿé”™è¯¯ï¼šè®°å½•æ—¥å¿—ï¼Œè¿”å›å‹å¥½ä¿¡æ¯
if err != nil {
    logx.WithContext(l.ctx).Errorf("ç³»ç»Ÿé”™è¯¯: %v", err)
    return nil, errors.New("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•")
}
```

### ğŸ¯ æœåŠ¡ä¾èµ–ç®¡ç†

1. **å¼ºä¾èµ–**: ç”¨æˆ·è®¤è¯ã€æ ¸å¿ƒä¸šåŠ¡æ•°æ®
   - ä½¿ç”¨ç†”æ–­å™¨ + é‡è¯•
   - å¿«é€Ÿå¤±è´¥ï¼Œè¿”å›æ˜ç¡®é”™è¯¯

2. **å¼±ä¾èµ–**: éæ ¸å¿ƒåŠŸèƒ½ã€ç»Ÿè®¡æ•°æ®
   - ä½¿ç”¨ç†”æ–­å™¨
   - é™çº§å¤„ç†ï¼Œè¿”å›é»˜è®¤å€¼

### ğŸ¯ æ€§èƒ½ä¼˜åŒ–

1. **è¿æ¥æ± **: ä½¿ç”¨KeepAliveå‡å°‘è¿æ¥å»ºç«‹å¼€é”€
2. **è¶…æ—¶æ§åˆ¶**: åˆç†è®¾ç½®DialTimeoutå’ŒTimeout
3. **æ‰¹é‡è°ƒç”¨**: å¯¹äºåˆ—è¡¨æŸ¥è¯¢ï¼Œè€ƒè™‘æ‰¹é‡RPCè°ƒç”¨

## å®æ–½æ—¶é—´è¡¨

### ç¬¬1å‘¨ï¼šæ ¸å¿ƒåŠŸèƒ½
- âœ… é…ç½®ä¼˜åŒ–å®Œæˆ
- âœ… ç†”æ–­å™¨å·¥å…·å®Œæˆ
- âœ… ServiceContextæ”¹é€ å®Œæˆ
- ğŸ”„ Loan/Leaseç”³è¯·æµç¨‹ç†”æ–­å™¨å®æ–½

### ç¬¬2å‘¨ï¼šç”¨æˆ·ç®¡ç†
- ğŸ“… AppUseræ¨¡å—ç†”æ–­å™¨å®æ–½
- ğŸ“… OaUseræ¨¡å—ç†”æ–­å™¨å®æ–½

### ç¬¬3å‘¨ï¼šäº§å“ç®¡ç†
- ğŸ“… LoanProductæ¨¡å—ç†”æ–­å™¨å®æ–½
- ğŸ“… LeaseProductæ¨¡å—ç†”æ–­å™¨å®æ–½

### ç¬¬4å‘¨ï¼šæµ‹è¯•å’Œä¼˜åŒ–
- ğŸ“… å®Œæ•´é›†æˆæµ‹è¯•
- ğŸ“… æ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜
- ğŸ“… ç›‘æ§å‘Šè­¦é…ç½®

## å¸¸è§é—®é¢˜è§£å†³

### Q1: æœåŠ¡å¯åŠ¨æ—¶è¿æ¥è¶…æ—¶
**åŸå› **: ä¾èµ–æœåŠ¡æœªå¯åŠ¨æˆ–ç½‘ç»œé—®é¢˜
**è§£å†³**: ç¡®è®¤LazyInit=trueï¼Œæ£€æŸ¥DialTimeoutè®¾ç½®

### Q2: ç†”æ–­å™¨é¢‘ç¹è§¦å‘
**åŸå› **: ä¾èµ–æœåŠ¡ä¸ç¨³å®šæˆ–é”™è¯¯åˆ†ç±»ä¸å‡†ç¡®
**è§£å†³**: ä¼˜åŒ–IsAcceptableErrorå‡½æ•°ï¼Œæ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€

### Q3: ä¸šåŠ¡é”™è¯¯è¢«ç†”æ–­
**åŸå› **: é”™è¯¯åˆ†ç±»ä¸å‡†ç¡®
**è§£å†³**: åœ¨IsAcceptableErrorä¸­æ·»åŠ æ›´å¤šä¸šåŠ¡é”™è¯¯å…³é”®è¯

## æ€»ç»“

é€šè¿‡æœ¬æŒ‡å—çš„å®Œæ•´å®æ–½ï¼ŒHuinongFinancial-Microserviceså°†å…·å¤‡ï¼š

1. âœ… **å¯åŠ¨å¥å£®æ€§**: æ‡’åŠ è½½è§£å†³æœåŠ¡ä¾èµ–é—®é¢˜
2. ğŸ”„ **è¿è¡Œæ—¶ä¿æŠ¤**: ç†”æ–­å™¨é˜²æ­¢çº§è”æ•…éšœ  
3. ğŸ“Š **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—
4. ğŸš€ **é«˜æ€§èƒ½**: ä¼˜åŒ–çš„è¿æ¥å’Œè¶…æ—¶é…ç½®

**å½“å‰è¿›åº¦**: çº¦40%å®Œæˆï¼Œå…³é”®åŸºç¡€è®¾æ–½å·²å°±ç»ª
**é¢„è®¡å®Œæˆæ—¶é—´**: 4å‘¨
**æŠ•å…¥äººåŠ›**: 2-3äººå¤©/å‘¨ 