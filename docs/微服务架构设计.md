# HuinongFinancial å¾®æœåŠ¡æ ‡å‡†æ¶æ„æŒ‡å— (SOP)

> æœ¬æ–‡æ¡£æ˜¯æƒ å†œé‡‘æœï¼ˆHuinongFinancialï¼‰é¡¹ç›®å¾®æœåŠ¡å¼€å‘çš„æ ‡å‡†ä½œä¸šç¨‹åºï¼ˆSOPï¼‰ã€‚æ‰€æœ‰æ–°å¾®æœåŠ¡çš„åˆ›å»ºã€å¼€å‘ã€é…ç½®å’Œéƒ¨ç½²éƒ½åº”ä¸¥æ ¼éµå¾ªæœ¬æŒ‡å—ã€‚
> 
> **å®Œæ•´å®è·µæ¡ˆä¾‹**ï¼š`app/appuser` æ¨¡å—å·²æŒ‰ç…§æœ¬æŒ‡å—å®Œæ•´å®ç°ï¼ŒåŒ…å«ç”¨æˆ·ç®¡ç†ã€ä¿¡ç”¨è¯„åˆ†ã€é£é™©è¯„ä¼°ç­‰å®Œæ•´ä¸šåŠ¡åŠŸèƒ½ï¼Œä»¥åŠå®Œæ•´çš„ Docker æ„å»ºå’Œ Kubernetes éƒ¨ç½²é…ç½®ï¼Œå¯ä½œä¸ºå›¢é˜Ÿå¼€å‘çš„æ ‡å‡†å‚è€ƒæ¨¡æ¿ã€‚

## ğŸš€ é‡è¦æ›´æ–°ï¼šGo Workspace ä¾èµ–ç®¡ç†

**æ–°ç‰¹æ€§**ï¼šæˆ‘ä»¬ç°åœ¨ä½¿ç”¨ **Go 1.18+ å¼•å…¥çš„ Go Workspace åŠŸèƒ½** è¿›è¡Œæœ¬åœ°æ¨¡å—ä¾èµ–ç®¡ç†ï¼Œæ›¿ä»£åŸæ¥çš„ `replace` æŒ‡ä»¤æ–¹æ¡ˆã€‚

### ä¸»è¦æ”¹è¿›
- âœ… **æ— éœ€ replace æŒ‡ä»¤**ï¼šå‘Šåˆ«å¤æ‚çš„ä¼ªç‰ˆæœ¬å·å’Œè·¯å¾„æ›¿æ¢
- âœ… **è‡ªåŠ¨åŒ–é…ç½®**ï¼šä»£ç ç”Ÿæˆè„šæœ¬è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†å·¥ä½œåŒº
- âœ… **IDE å‹å¥½**ï¼šæ›´å¥½çš„ä»£ç å¯¼èˆªå’Œæ™ºèƒ½æç¤ºæ”¯æŒ
- âœ… **ç®€åŒ–å¼€å‘**ï¼šç»Ÿä¸€çš„å·¥ä½œåŒºç¯å¢ƒï¼Œå‡å°‘é…ç½®é”™è¯¯

### å¿«é€Ÿå¼€å§‹
```bash
# ç”Ÿæˆä»£ç å¹¶è‡ªåŠ¨è®¾ç½®å·¥ä½œåŒº
./scripts/gen-code.sh appuser all

# æˆ–å•ç‹¬è®¾ç½®å·¥ä½œåŒº
./scripts/gen-code.sh appuser workspace
```

> **æ³¨æ„**ï¼šæœ¬æŒ‡å—å·²å…¨é¢æ›´æ–°ä¸º Go Workspace æ–¹æ¡ˆã€‚å¦‚æœæ‚¨ä¹‹å‰ä½¿ç”¨ `replace` æŒ‡ä»¤ï¼Œå»ºè®®è¿ç§»åˆ°æ–°æ–¹æ¡ˆä»¥è·å¾—æ›´å¥½çš„å¼€å‘ä½“éªŒã€‚

## ç›®å½•

1. [æ ¸å¿ƒæ¶æ„ï¼šAPI + RPC åˆ†å±‚æ¨¡å¼](#1-æ ¸å¿ƒæ¶æ„api--rpc-åˆ†å±‚æ¨¡å¼)
2. [AppUser æ¨¡å—å®è·µæ¡ˆä¾‹](#2-appuser-æ¨¡å—å®è·µæ¡ˆä¾‹)
3. [æ ‡å‡†å¼€å‘æµç¨‹](#3-æ ‡å‡†å¼€å‘æµç¨‹)
4. [AppUser æ¨¡å—éƒ¨ç½²ä¸ä½¿ç”¨](#4-appuser-æ¨¡å—éƒ¨ç½²ä¸ä½¿ç”¨)
5. [å¾®æœåŠ¡ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ](#5-å¾®æœåŠ¡ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ)

---

## 1. æ ¸å¿ƒæ¶æ„ï¼šAPI + RPC åˆ†å±‚æ¨¡å¼

æˆ‘ä»¬é‡‡ç”¨ `API` + `RPC` çš„ç»å…¸åˆ†å±‚æ¶æ„ï¼Œå°†æ¯ä¸ªå¾®æœåŠ¡ï¼ˆå¦‚ `appuser`ï¼‰åœ¨é€»è¾‘å’Œç‰©ç†ä¸Šæ‹†åˆ†ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„ Go æ¨¡å—ã€‚è¯¦ç»†ä»£ç å®è·µå†…å®¹è¯·å‚è€ƒ `app/appuser` ç›®å½•ã€‚

> **å®è·µå‚è€ƒ**ï¼š`app/appuser` æ¨¡å—æ˜¯æŒ‰ç…§æœ¬æ¶æ„æŒ‡å—å®Œæ•´å®ç°çš„æ ‡å‡†ç¤ºä¾‹ï¼ŒåŒ…å«å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ã€ä¿¡ç”¨è¯„åˆ†ã€é£é™©è¯„ä¼°ç­‰ä¸šåŠ¡åŠŸèƒ½ï¼Œä»¥åŠå®Œæ•´çš„ Docker æ„å»ºå’Œ Kubernetes éƒ¨ç½²é…ç½®ã€‚æ‰€æœ‰æ–°æœåŠ¡éƒ½åº”å‚è€ƒæ­¤æ¨¡å—çš„å®ç°æ–¹å¼ã€‚

### 1.1 æ¶æ„å›¾

```mermaid
graph TD;
    A[ç”¨æˆ·è¯·æ±‚] --> B[API æ¨¡å—<br/>(HTTP/HTTPS)];
    B --> C{RPC æ¨¡å—<br/>(gRPC ä¸šåŠ¡é€»è¾‘)};
    C --> D[Model æ¨¡å—<br/>(æ•°æ®è®¿é—®)];
    D -- SQL --> E[(æ•°æ®åº“/ç¼“å­˜)];

    subgraph "å¾®æœåŠ¡: appuser"
        direction LR
        subgraph "cmd/api"
            B
        end
        subgraph "cmd/rpc"
            C
        end
        subgraph "cmd/model"
            D
        end
    end

    style B fill:#cde4ff,stroke:#333,stroke-width:2px
    style C fill:#d5e8d4,stroke:#333,stroke-width:2px
    style D fill:#ffe6cc,stroke:#333,stroke-width:2px
```

### 1.2 æ¨¡å—èŒè´£ä¸åŸåˆ™

-   **`api` æ¨¡å—**:
    -   **èŒè´£**: å¯¹å¤– HTTP æµé‡å…¥å£ï¼Œåè®®è½¬æ¢å±‚ã€‚
    -   **ä»»åŠ¡**: å®šä¹‰ API è·¯ç”±ã€å‚æ•°æ ¡éªŒã€JWT é‰´æƒã€è°ƒç”¨ä¸‹æ¸¸ RPCã€‚
    -   **åŸåˆ™**: **ä¸¥ç¦åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œä¸¥ç¦ç›´æ¥è®¿é—®æ•°æ®åº“æˆ–ç¼“å­˜ã€‚**

-   **`rpc` æ¨¡å—**:
    -   **èŒè´£**: ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒï¼Œå¯¹å†… gRPC æœåŠ¡æä¾›è€…ã€‚
    -   **ä»»åŠ¡**: å®ç°ä¸šåŠ¡é€»è¾‘ã€å¤„ç†äº‹åŠ¡ã€é€šè¿‡ Model æ¨¡å—è®¿é—®æ•°æ®ã€‚
    -   **åŸåˆ™**: **åªæä¾›çº¯ç²¹çš„ä¸šåŠ¡èƒ½åŠ›æ¥å£ï¼Œä¸å…³å¿ƒä¸Šæ¸¸åè®®ã€‚**

-   **`model` æ¨¡å—**:
    -   **èŒè´£**: æ•°æ®è®¿é—®å±‚ (DAO)ã€‚
    -   **ä»»åŠ¡**: å®šä¹‰æ•°æ®è¡¨ç»“æ„ã€æä¾› CRUD æ–¹æ³•ã€å¤„ç†ç¼“å­˜é€»è¾‘ã€‚
    -   **åŸåˆ™**: **ä¸¥ç¦åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œåªæä¾›çº¯ç²¹çš„æ•°æ®æ“ä½œã€‚**

## 2. AppUser æ¨¡å—å®è·µæ¡ˆä¾‹

### 2.1 ä¸šåŠ¡åŠŸèƒ½æ¦‚è§ˆ

`app/appuser` æ¨¡å—æ˜¯å®Œæ•´å®ç°çš„ç”¨æˆ·ç®¡ç†å¾®æœåŠ¡ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

#### **ç”¨æˆ·è®¤è¯ä¸ç®¡ç†**
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•éªŒè¯
- å¯†ç ç®¡ç†ï¼ˆä¿®æ”¹ã€é‡ç½®ï¼‰
- ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼ˆæ­£å¸¸ã€å†»ç»“ã€ç¦ç”¨ï¼‰
- ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯ç»´æŠ¤

#### **ä¿¡ç”¨è¯„åˆ†ç³»ç»Ÿ**
- å¤šç»´åº¦ä¿¡ç”¨è¯„åˆ†è®¡ç®—
- è¯„åˆ†å†å²è®°å½•è¿½è¸ª
- è‡ªåŠ¨/æ‰‹åŠ¨è¯„åˆ†æ›´æ–°
- ä¿¡ç”¨ç­‰çº§è¯„å®š

#### **é£é™©è¯„ä¼°å¼•æ“**
- è´·æ¬¾/ç§Ÿèµé£é™©è¯„ä¼°
- å¤šå› å­é£é™©åˆ†æ
- è¯„ä¼°ç»“æœå»ºè®®
- å†å²è¯„ä¼°è®°å½•

#### **ç”¨æˆ·è®¤è¯ä½“ç³»**
- èº«ä»½è®¤è¯ï¼ˆèº«ä»½è¯ã€é“¶è¡Œå¡ï¼‰
- è®¤è¯çŠ¶æ€ç®¡ç†
- è®¤è¯æ•°æ®å­˜å‚¨

### 2.2 API è®¾è®¡äº®ç‚¹

#### **åˆ†å±‚æƒé™æ§åˆ¶**
```go
// æ™®é€šç”¨æˆ· APIï¼ˆJWT è®¤è¯ï¼‰
@server(jwt: Auth)
service appuser {
    get /info returns (DataResp)        // è·å–ä¸ªäººä¿¡æ¯
    put /profile (UpdateProfileReq)     // æ›´æ–°ä¸ªäººæ¡£æ¡ˆ
}

// å…¬å¼€ APIï¼ˆæ— éœ€è®¤è¯ï¼‰
@server()
service appuser {
    post /register (RegisterReq)        // ç”¨æˆ·æ³¨å†Œ
    get /check-account/:account         // æ£€æŸ¥è´¦å·å¯ç”¨æ€§
}

// ç®¡ç†å‘˜ APIï¼ˆJWT + ç®¡ç†å‘˜æƒé™ï¼‰
@server(jwt: Auth, middleware: AdminAuth)
service appuser {
    get /admin/users (GetUsersReq)      // ç”¨æˆ·åˆ—è¡¨ç®¡ç†
    put /admin/users/status             // ç”¨æˆ·çŠ¶æ€ç®¡ç†
}
```

#### **RESTful è®¾è®¡è§„èŒƒ**
- **èµ„æºå¯¼å‘**ï¼š`/appuser/profile`ã€`/appuser/credit-score`
- **HTTP åŠ¨è¯**ï¼šGETï¼ˆæŸ¥è¯¢ï¼‰ã€POSTï¼ˆåˆ›å»ºï¼‰ã€PUTï¼ˆæ›´æ–°ï¼‰
- **ç»Ÿä¸€å“åº”**ï¼š`DataResp`ã€`PageResp`ã€`CommonResp`
- **è·¯å¾„å‚æ•°**ï¼š`/admin/users/:id`ã€`/check-account/:account`

#### **ç±»å‹è®¾è®¡åŸåˆ™**
- **API å±‚**ï¼šåªå®šä¹‰ HTTP ç‰¹æœ‰çš„è¯·æ±‚ç±»å‹ï¼ˆè¡¨å•ç»‘å®šã€å‚æ•°éªŒè¯ï¼‰
- **RPC å±‚**ï¼šå®šä¹‰å®Œæ•´çš„ä¸šåŠ¡æ•°æ®ç±»å‹å’Œæ¥å£
- **é¿å…é‡å¤**ï¼šå¤æ‚ä¸šåŠ¡ç±»å‹åœ¨ RPC å±‚ç»Ÿä¸€å®šä¹‰ï¼ŒAPI å±‚é€šè¿‡ `interface{}` è¿”å›

### 2.3 æ•°æ®æ¨¡å‹è®¾è®¡

#### **æ ¸å¿ƒè¡¨ç»“æ„**
```sql
-- ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE `app_users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `account` varchar(20) NOT NULL COMMENT 'è´¦å·(æ‰‹æœºå·)',
  `name` varchar(50) NOT NULL COMMENT 'ç”¨æˆ·å§“å',
  `age` int NOT NULL COMMENT 'å¹´é¾„',
  `gender` tinyint NOT NULL DEFAULT '0' COMMENT 'æ€§åˆ« 0:æœªçŸ¥ 1:ç”· 2:å¥³',
  `income` decimal(15,2) DEFAULT '0.00' COMMENT 'æœˆæ”¶å…¥',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'çŠ¶æ€ 1:æ­£å¸¸ 2:å†»ç»“ 3:ç¦ç”¨',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_account` (`account`)
);

-- ç”¨æˆ·ä¿¡ç”¨è¯„åˆ†è¡¨
CREATE TABLE `user_credit_scores` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·ID',
  `real_estate_value` decimal(15,2) DEFAULT '0.00' COMMENT 'æˆ¿äº§ä»·å€¼',
  `total_score` int NOT NULL DEFAULT '0' COMMENT 'æ€»ä¿¡ç”¨è¯„åˆ†',
  `credit_level` varchar(20) NOT NULL DEFAULT '' COMMENT 'ä¿¡ç”¨ç­‰çº§',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
);
```

#### **æ¨¡å‹ç‰¹ç‚¹**
- **è§„èŒƒåŒ–è®¾è®¡**ï¼šé¿å…æ•°æ®å†—ä½™ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§
- **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºæŸ¥è¯¢çƒ­ç‚¹å­—æ®µå»ºç«‹ç´¢å¼•
- **æ‰©å±•æ€§**ï¼šé¢„ç•™å­—æ®µæ”¯æŒæœªæ¥ä¸šåŠ¡æ‰©å±•
- **ç¼“å­˜å‹å¥½**ï¼šé€šè¿‡ go-zero è‡ªåŠ¨ç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½

### 2.4 æ„å»ºä¸éƒ¨ç½²ä½“ç³»

#### **åŒæ¨¡å¼ Docker æ„å»º**
- **æœ¬åœ°æ„å»ºæ¨¡å¼**ï¼š`api.Dockerfile` / `rpc.Dockerfile` - æé€Ÿæ„å»ºï¼Œåˆ©ç”¨æœ¬åœ° Go ç¼“å­˜
- **å®¹å™¨æ„å»ºæ¨¡å¼**ï¼š`api.build.Dockerfile` / `rpc.build.Dockerfile` - ç¯å¢ƒéš”ç¦»ï¼Œé€‚åˆ CI/CD

#### **ç”Ÿäº§çº§ Kubernetes éƒ¨ç½²**
- **é«˜å¯ç”¨é…ç½®**ï¼šAPI 3å‰¯æœ¬ï¼ŒRPC 2å‰¯æœ¬
- **è‡ªåŠ¨æ‰©ç¼©å®¹**ï¼šHPA é…ç½®ï¼ŒCPU/å†…å­˜é˜ˆå€¼è§¦å‘
- **å¥åº·æ£€æŸ¥**ï¼šå°±ç»ªæ¢é’ˆ + å­˜æ´»æ¢é’ˆ
- **èµ„æºé…ç½®**ï¼šç²¾ç¡®çš„ CPU/å†…å­˜é™åˆ¶

#### **å®Œæ•´ CI/CD æµç¨‹**
```bash
# ä¸€é”®æ„å»ºã€æ¨é€ã€éƒ¨ç½²
cd app/appuser
./build.sh v1.0.0 deploy

# æ”¯æŒå¤šç§æ„å»ºæ¨¡å¼
BUILD_MODE=local ./build.sh v1.0.0 build    # æœ¬åœ°æ„å»ºï¼ˆæ¨èï¼‰
BUILD_MODE=docker ./build.sh v1.0.0 build   # å®¹å™¨æ„å»º
```

### 2.5 API ä¸ RPC å“åº”è®¾è®¡åŸåˆ™ (Best Practice)

ä¸ºäº†ç¡®ä¿å‰ç«¯äº¤äº’çš„ç»Ÿä¸€æ€§å’Œå†…éƒ¨æœåŠ¡çš„é«˜æ•ˆæ€§ï¼Œæˆ‘ä»¬è§„å®šäº†ä¸åŒçš„å“åº”è®¾è®¡ç­–ç•¥ã€‚

**æ ¸å¿ƒåŸåˆ™ï¼šåˆ›å»º(Create)å’Œæ›´æ–°(Update)æ“ä½œï¼Œå¿…é¡»è¿”å›å…¶å½±å“çš„å®Œæ•´èµ„æºå¯¹è±¡ã€‚** è¿™æœ‰åˆ©äºå®¢æˆ·ç«¯è¿›è¡ŒçŠ¶æ€æ›´æ–°ï¼Œå¹¶å‡å°‘ä¸å¿…è¦çš„äºŒæ¬¡æŸ¥è¯¢ã€‚

#### **API å±‚ï¼šç»Ÿä¸€å“åº”æ¨¡å‹**

æ‰€æœ‰ `api` æœåŠ¡å¯¹å¤–æš´éœ²çš„ HTTP æ¥å£ï¼Œ**å¿…é¡»** ä½¿ç”¨ä»¥ä¸‹ä¸‰ç§æ ‡å‡†ç»“æ„è¿›è¡Œå“åº”ã€‚è¿™æœ‰åˆ©äºå‰ç«¯ç»Ÿä¸€å¤„ç†ã€ç»Ÿä¸€æ‹¦æˆªå’Œç»Ÿä¸€å±•ç¤ºã€‚

-   **`CommonResp`**: ç”¨äº**çœŸæ­£æ²¡æœ‰æ•°æ®ä½“è¿”å›**çš„æ“ä½œï¼Œå¦‚ `DELETE`, `Logout`ã€‚
    ```go
    type CommonResp {
        Code    int32  `json:"code"`
        Message string `json:"message"`
    }
    ```

> **å®è·µ**: åœ¨ `.api` æ–‡ä»¶ä¸­ç»Ÿä¸€å®šä¹‰è¿™äº›ç±»å‹ï¼Œå¹¶åœ¨ `service` ä¸­å¼•ç”¨å®ƒä»¬ã€‚å¯¹äºåˆ›å»ºå’Œæ›´æ–°æ“ä½œï¼Œåº”ä½¿ç”¨ `DataResp`ã€‚

#### **RPC å±‚ï¼šå…·ä½“ã€å¼ºç±»å‹çš„å“åº”æ¨¡å‹**

æ‰€æœ‰ `rpc` æœåŠ¡å¯¹å†…æä¾›çš„ gRPC æ¥å£ï¼Œ**ä¸¥ç¦** ä½¿ç”¨é€šç”¨å“åº”ç»“æ„ã€‚æ¯ä¸ªæ–¹æ³•çš„å“åº”éƒ½åº”æ˜¯å…·ä½“ã€æœ€å°åŒ–çš„ä¸šåŠ¡æ•°æ®ç»“æ„ã€‚

-   **æ­£ç¡®ç¤ºä¾‹ (Good)**:
    ```protobuf
    service User {
        rpc GetUser(GetUserReq) returns (GetUserResp);
        // æ›´æ–°æ“ä½œä¹Ÿåº”è¯¥è¿”å›æ›´æ–°åçš„èµ„æº
        rpc UpdateUser(UpdateUserReq) returns (UserInfo);
    }
    message GetUserResp {
        UserInfo user = 1;
    }
    ```
-   **é”™è¯¯ç¤ºä¾‹ (Bad)**:
    ```protobuf
    // ä¸¥ç¦åœ¨ RPC ä¸­ä½¿ç”¨æ­¤ç±»åŒ…è£…
    message RpcDataResp {
        int32 code = 1;
        string message = 2;
        google.protobuf.Any data = 3;
    }
    ```

#### **è§£è€¦ä¸åä½œ**

`API` å±‚å’Œ `RPC` å±‚é€šè¿‡ `Logic` å±‚è¿›è¡Œè§£è€¦ã€‚`Logic` æ–‡ä»¶çš„èŒè´£å°±æ˜¯è°ƒç”¨ RPC è·å–çº¯ä¸šåŠ¡æ•°æ®ï¼Œç„¶åå°†å…¶ç»„è£…æˆæ ‡å‡†çš„ API å“åº”ç»“æ„ã€‚

```go
// åœ¨ api/internal/logic/getuserlogic.go ä¸­
func (l *GetUserLogic) GetUser(req *types.GetUserReq) (resp *types.DataResp, err error) {
    // 1. è°ƒç”¨ RPC è·å–çº¯ä¸šåŠ¡æ•°æ®
    rpcResp, err := l.svcCtx.UserRpc.GetUser(l.ctx, &userclient.GetUserReq{Id: req.Id})
    if err != nil {
        return nil, err // é”™è¯¯ä¼šè¢«æ¡†æ¶è‡ªåŠ¨åŒ…è£…
    }

    // 2. å°† RPC å“åº”ç»„è£…æˆæ ‡å‡†çš„ API å“åº”
    return &types.DataResp{
        Code:    200,
        Message: "success",
        Data:    rpcResp.User, // å°†å…·ä½“çš„ä¸šåŠ¡æ•°æ®æ”¾å…¥ Data å­—æ®µ
    }, nil
}
```

### 2.6 ç‰¹æ®Šè§„èŒƒï¼šå…³äºç©ºæ¶ˆæ¯çš„å¤„ç†

**æ‰€æœ‰`rpc`æœåŠ¡å¯¹å†…æä¾›çš„ gRPC æ¥å£ï¼Œå½“ä¸èƒ½ä½¿ç”¨ç©ºå“åº”ã€‚**

---

## 3. æ ‡å‡†å¼€å‘æµç¨‹

### æ­¥éª¤ä¸€ï¼šå®šä¹‰æœåŠ¡

1.  **API å®šä¹‰**: åœ¨ `app/<service>/<service>-api.api` æ–‡ä»¶ä¸­å®šä¹‰ HTTP æ¥å£ã€è¯·æ±‚å’Œå“åº”ç»“æ„ã€‚
2.  **RPC å®šä¹‰**: åœ¨ `app/<service>/<service>-rpc.proto` æ–‡ä»¶ä¸­å®šä¹‰ gRPC æ¥å£å’Œæ¶ˆæ¯ä½“ã€‚
3.  **æ•°æ®æ¨¡å‹å®šä¹‰**: åœ¨ `app/<service>/<service>.sql` æ–‡ä»¶ä¸­å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ã€‚

> **å®è·µç¤ºä¾‹**ï¼šå‚è€ƒ `app/appuser/appuser-api.api`ã€`app/appuser/appuser-rpc.proto` å’Œ `app/appuser/appuser.sql` æ–‡ä»¶ã€‚

### æ­¥éª¤äºŒï¼šç”Ÿæˆä»£ç 

ä½¿ç”¨é¡¹ç›®æä¾›çš„è„šæœ¬ä¸€é”®ç”Ÿæˆæ‰€æœ‰æ¨¡å—çš„åŸºç¡€ä»£ç ã€‚
```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
./scripts/gen-code.sh appuser all
```

> **å®è·µè¯´æ˜**ï¼šappuser æ¨¡å—å·²å®Œæ•´ç”Ÿæˆï¼ŒåŒ…å« 117 ä¸ªæ–‡ä»¶çš„å®Œæ•´ä¸‰å±‚æ¶æ„ä»£ç ã€‚

### æ­¥éª¤ä¸‰ï¼šé…ç½®æ¨¡å—ä¾èµ– (Go Workspace)

**é‡è¦å‡çº§**ï¼šæˆ‘ä»¬ç°åœ¨ä½¿ç”¨ Go 1.18+ å¼•å…¥çš„ **Go Workspace** åŠŸèƒ½ï¼Œè¿™æ˜¯æ¯” `replace` æŒ‡ä»¤æ›´ç°ä»£ã€æ›´ä¼˜é›…çš„æœ¬åœ°æ¨¡å—ç®¡ç†æ–¹æ¡ˆã€‚

#### **Go Workspace çš„ä¼˜åŠ¿**
- **æ— éœ€ replace æŒ‡ä»¤**ï¼šé¿å…ä¼ªç‰ˆæœ¬å·å’Œå¤æ‚çš„è·¯å¾„æ›¿æ¢
- **ç»Ÿä¸€ç®¡ç†**ï¼šä¸€ä¸ª `go.work` æ–‡ä»¶ç®¡ç†æ‰€æœ‰ç›¸å…³æ¨¡å—
- **IDE å‹å¥½**ï¼šæ›´å¥½çš„ä»£ç å¯¼èˆªå’Œè‡ªåŠ¨è¡¥å…¨æ”¯æŒ
- **ç‰ˆæœ¬æ§åˆ¶**ï¼š`go.work` æ–‡ä»¶é€šå¸¸ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼Œé¿å…ç¯å¢ƒå·®å¼‚

#### **è‡ªåŠ¨é…ç½®å·¥ä½œåŒº**
ä»£ç ç”Ÿæˆè„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºå’Œé…ç½® Go Workspaceï¼š

```bash
# ç”Ÿæˆä»£ç æ—¶è‡ªåŠ¨è®¾ç½®å·¥ä½œåŒº
./scripts/gen-code.sh appuser all

# æˆ–å•ç‹¬è®¾ç½®å·¥ä½œåŒº
./scripts/gen-code.sh appuser workspace
```

#### **å·¥ä½œåŒºç»“æ„**
ç”Ÿæˆåçš„ç›®å½•ç»“æ„ï¼š
```
app/appuser/cmd/
â”œâ”€â”€ go.work              # å·¥ä½œåŒºé…ç½®æ–‡ä»¶ (è‡ªåŠ¨ç”Ÿæˆ)
â”œâ”€â”€ api/
â”‚   â””â”€â”€ go.mod          # APIæ¨¡å—é…ç½®
â”œâ”€â”€ rpc/
â”‚   â””â”€â”€ go.mod          # RPCæ¨¡å—é…ç½®  
â””â”€â”€ model/
    â””â”€â”€ go.mod          # Modelæ¨¡å—é…ç½®
```

#### **`go.work` æ–‡ä»¶ç¤ºä¾‹**
```go
// app/appuser/cmd/go.work (è‡ªåŠ¨ç”Ÿæˆ)
go 1.24.3

use (
    ./api
    ./rpc
    ./model
)
```

#### **æ¨¡å—é…ç½®ç®€åŒ–**

-   **`app/appuser/cmd/model/go.mod`** (æ— å˜åŒ–):
    ```go
    module model

    go 1.24.3

    require github.com/zeromicro/go-zero v1.8.4
    ```

-   **`app/appuser/cmd/rpc/go.mod`** (ç®€åŒ–ç‰ˆ):
    ```go
    module rpc

    go 1.24.3

    require (
        github.com/zeromicro/go-zero v1.8.4
        github.com/zeromicro/zero-contrib/zrpc/registry/consul v0.0.0-20231030135404-af9ae855016f
        model v0.0.0 // é€šè¿‡å·¥ä½œåŒºè‡ªåŠ¨è§£æï¼Œæ— éœ€ç‰ˆæœ¬å·
    )
    // æ— éœ€ replace æŒ‡ä»¤ï¼
    ```

-   **`app/appuser/cmd/api/go.mod`** (ç®€åŒ–ç‰ˆ):
    ```go
    module api

    go 1.24.3

    require (
        github.com/zeromicro/go-zero v1.8.4
        github.com/zeromicro/zero-contrib/zrpc/registry/consul v0.0.0-20231030135404-af9ae855016f
        rpc v0.0.0 // é€šè¿‡å·¥ä½œåŒºè‡ªåŠ¨è§£æï¼Œæ— éœ€ç‰ˆæœ¬å·
    )
    // æ— éœ€ replace æŒ‡ä»¤ï¼
    ```

#### **å¼€å‘å·¥ä½œæµ**
1. **åœ¨å·¥ä½œåŒºæ ¹ç›®å½•æ“ä½œ**ï¼š`cd app/appuser/cmd`
2. **æ„å»ºä»»æ„æ¨¡å—**ï¼š`go build ./api`ã€`go build ./rpc`
3. **è¿è¡Œæµ‹è¯•**ï¼š`go test ./...` (æµ‹è¯•æ‰€æœ‰æ¨¡å—)
4. **ä¾èµ–ç®¡ç†**ï¼š`go work sync` (åŒæ­¥å·¥ä½œåŒºä¾èµ–)

### æ­¥éª¤å››ï¼šå®Œå–„æœåŠ¡é…ç½® (`.yaml`)

#### **RPC æœåŠ¡é…ç½® (`appuserrpc.yaml`)**
> **ç›®æ ‡**: é…ç½®ä¸€ä¸ªå®Œæ•´çš„ã€å¯ç‹¬ç«‹è¿è¡Œçš„ä¸šåŠ¡æœåŠ¡ã€‚åŒ…å«æœåŠ¡ç›‘å¬ã€æœåŠ¡æ³¨å†Œã€æ•°æ®åº“ã€ç¼“å­˜ç­‰æ‰€æœ‰å¿…è¦ä¾èµ–ã€‚

> **å®è·µå‚è€ƒ**: `app/appuser/cmd/rpc/etc/appuserrpc.yaml` æ–‡ä»¶ã€‚ç«¯å£é…ç½®ä¸º 20001 ä¾æ¬¡ç±»æ¨ã€‚

```yaml
# app/appuser/cmd/rpc/etc/appuserrpc.yaml
Name: appuserrpc.rpc
ListenOn: 0.0.0.0:20001

# Consul æœåŠ¡æ³¨å†Œé…ç½®
# ä½œç”¨ï¼šå°†æœ¬æœåŠ¡æ³¨å†Œåˆ° Consulï¼Œä»¥ä¾¿å…¶ä»–æœåŠ¡å¯ä»¥å‘ç°å¹¶è°ƒç”¨ã€‚
Consul:
  Host: consul.huinong.internal
  Key: appuserrpc.rpc # æœåŠ¡åœ¨ Consul ä¸­çš„å”¯ä¸€æ ‡è¯†
  Token: "331c00f9-bd87-2383-4394-548a0e66dea9"

# æ•°æ®åº“é…ç½®
MySQL:
  DataSource: appuser:appuser@tcp(10.10.10.6:3306)/appuser?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai

# Redis ç¼“å­˜é…ç½®
# ä½œç”¨ï¼šgo-zero model è‡ªåŠ¨ä½¿ç”¨ redis ç¼“å­˜é«˜é¢‘æŸ¥è¯¢ (å¦‚ FindOne)ï¼Œæå‡æ€§èƒ½ã€‚
CacheConf:
  - Host: 10.10.10.6:6379
    Type: node
    Pass: "ChinaSkills@"

# æ—¥å¿—é…ç½®
Log:
  ServiceName: appuserrpc
  Mode: file # æœ¬åœ°å¼€å‘è®°å…¥æ–‡ä»¶ï¼ŒK8sä¸­åº”ä½¿ç”¨ console
  Path: logs
  Level: info
  KeepDays: 7
  Compress: true
```

#### **API æœåŠ¡é…ç½® (`appuser.yaml`)**

> **ç›®æ ‡**: é…ç½®ä¸€ä¸ªè½»é‡çº§çš„ç½‘å…³å±‚ã€‚å®ƒåªå…³å¿ƒ HTTP åè®®å’Œä¸‹æ¸¸ RPC æœåŠ¡çš„è¿æ¥ï¼Œå¯¹æ•°æ®åº“ã€ç¼“å­˜ç­‰ä¸€æ— æ‰€çŸ¥ã€‚

> **å®è·µå‚è€ƒ**: `app/appuser/cmd/api/etc/appuser.yaml` æ–‡ä»¶ã€‚ç«¯å£é…ç½®ä¸º 10001 ä¾æ¬¡ç±»æ¨ã€‚

```yaml
# app/appuser/cmd/api/etc/appuser.yaml
Name: appuser-api
Host: 0.0.0.0
Port: 10001

# JWT è®¤è¯é…ç½®
Auth:
  AccessSecret: "huinong-auth-access-secret"
  AccessExpire: 3600

# RPC å®¢æˆ·ç«¯é…ç½® (äºŒé€‰ä¸€)
AppUserRpc:
  # æ¨¡å¼ä¸€ï¼šç›´è¿æ¨¡å¼ (æ¨èï¼šå¼€å‘ç¯å¢ƒ / APIä¸RPCå•å®¹å™¨éƒ¨ç½²)
  # ç†ç”±ï¼šæœ¬åœ°è°ƒç”¨ï¼Œæ— ç½‘ç»œå’ŒæœåŠ¡å‘ç°å¼€é”€ï¼Œæ€§èƒ½æœ€é«˜ï¼Œè°ƒè¯•æ–¹ä¾¿ã€‚
  # Endpoints:
  #   - 127.0.0.1:20001
  
  # æ¨¡å¼äºŒï¼šæœåŠ¡å‘ç°æ¨¡å¼ (æ¨èï¼šæµ‹è¯• / ç”Ÿäº§ç¯å¢ƒ / K8s åˆ†ç¦»éƒ¨ç½²)
  # ç†ç”±ï¼šæ”¯æŒ RPC æœåŠ¡æ°´å¹³æ‰©å±•ã€è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»ï¼Œæ˜¯æ ‡å‡†çš„ç”Ÿäº§çº§é…ç½®ã€‚
  # æ³¨æ„ï¼šå®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°é…ç½®ä½¿ç”¨ Target URL æ ¼å¼ï¼Œè€Œä¸æ˜¯ç»“æ„åŒ–é…ç½®ã€‚
  Target: consul://consul.huinong.internal/appuserrpc.rpc

# æ—¥å¿—é…ç½®
Log:
  ServiceName: appuser-api
  Mode: file # æœ¬åœ°å¼€å‘è®°å…¥æ–‡ä»¶ï¼ŒK8sä¸­åº”ä½¿ç”¨ console
  Path: logs
  Level: info
  KeepDays: 7
  Compress: true
```

### æ­¥éª¤äº”ï¼šå®Œå–„ä»£ç å®ç°

#### **RPC æœåŠ¡ (`rpc/` ç›®å½•)**

1.  **`internal/config/config.go`**: ç¡®ä¿é…ç½®ç»“æ„ä½“ä¸ `appuserrpc.yaml` ä¸€è‡´ã€‚
    ```go
    type Config struct {
        zrpc.RpcServerConf
        Consul consul.Conf
        MySQL  struct {
            DataSource string
        }
        CacheConf cache.CacheConf
    }
    ```
    > **å®è·µå‚è€ƒ**: `app/appuser/cmd/rpc/internal/config/config.go`
2.  **`internal/svc/servicecontext.go`**: åˆå§‹åŒ–æ‰€æœ‰ `model` å®ä¾‹ã€‚
    ```go
    // RPC çš„ servicecontext éœ€è¦æŒæœ‰æ‰€æœ‰æ•°æ®æ¨¡å‹çš„å®ä¾‹
    type servicecontext struct {
        Config                  config.Config
        AppUsersModel           model.AppUsersModel
        UserCreditScoresModel   model.UserCreditScoresModel
        CreditScoreHistoryModel model.CreditScoreHistoryModel
        RiskAssessmentsModel    model.RiskAssessmentsModel
        UserVerificationsModel  model.UserVerificationsModel
    }

    func Newservicecontext(c config.Config) *servicecontext {
        conn := sqlx.NewMysql(c.MySQL.DataSource)
        return &servicecontext{
            Config:                  c,
            AppUsersModel:           model.NewAppUsersModel(conn, c.CacheConf),
            UserCreditScoresModel:   model.NewUserCreditScoresModel(conn, c.CacheConf),
            CreditScoreHistoryModel: model.NewCreditScoreHistoryModel(conn, c.CacheConf),
            RiskAssessmentsModel:    model.NewRiskAssessmentsModel(conn, c.CacheConf),
            UserVerificationsModel:  model.NewUserVerificationsModel(conn, c.CacheConf),
        }
    }
    ```
    > **å®è·µå‚è€ƒ**: `app/appuser/cmd/rpc/internal/svc/servicecontext.go`
3.  **`appuserrpc.go`**: æ·»åŠ  Consul æœåŠ¡æ³¨å†Œé€»è¾‘ã€‚
    ```go
    import "github.com/zeromicro/zero-contrib/zrpc/registry/consul"

    // ...
    s := zrpc.MustNewServer(...)
    defer s.Stop()

    // å°†æœ¬æœåŠ¡æ³¨å†Œåˆ° Consul
    if err := consul.RegisterService(c.ListenOn, c.Consul); err != nil {
        log.Fatalf("register consul error: %v", err)
    }

    s.Start()
    ```
    > **å®è·µå‚è€ƒ**: `app/appuser/cmd/rpc/appuserrpc.go`

#### **API æœåŠ¡ (`api/` ç›®å½•)**

1.  **`internal/config/config.go`**: ç¡®ä¿é…ç½®ç»“æ„ä½“ä¸ `appuser.yaml` ä¸€è‡´ã€‚
    ```go
    type Config struct {
        rest.RestConf
        Auth struct {
            AccessSecret string
            AccessExpire int64
        }
        AppUserRpc zrpc.RpcClientConf
    }
    ```
    > **å®è·µå‚è€ƒ**: `app/appuser/cmd/api/internal/config/config.go`
2.  **`internal/svc/servicecontext.go`**: åªåˆå§‹åŒ–ä¸‹æ¸¸ RPC å®¢æˆ·ç«¯ã€‚
    ```go
    // API çš„ servicecontext åªæŒæœ‰ RPC å®¢æˆ·ç«¯ï¼Œä¸å…³å¿ƒæ•°æ®å±‚
    type servicecontext struct {
        Config     config.Config
        AdminAuth  rest.Middleware
        AppUserRpc appuserclient.AppUser
    }

    func Newservicecontext(c config.Config) *servicecontext {
        return &servicecontext{
            Config:     c,
            AdminAuth:  middleware.NewAdminAuthMiddleware().Handle,
            AppUserRpc: appuserclient.NewAppUser(zrpc.MustNewClient(c.AppUserRpc)),
        }
    }
    ```
    > **å®è·µå‚è€ƒ**: `app/appuser/cmd/api/internal/svc/servicecontext.go`
3.  **`appuser.go`**: å¯¼å…¥ Consul åŒ…ä»¥å¯ç”¨æœåŠ¡å‘ç°ã€‚
    ```go
    // åŒ¿åå¯¼å…¥ä»¥è§¦å‘ init å‡½æ•°ï¼Œæ³¨å†Œ consul resolver
    import _ "github.com/zeromicro/zero-contrib/zrpc/registry/consul"
    ```
    > **å®è·µå‚è€ƒ**: `app/appuser/cmd/api/appuser.go`

### æ­¥éª¤å…­ï¼šè§£å†³ä¾èµ–ä¸ç¼–è¯‘

ä½¿ç”¨ Go Workspace åï¼Œä¾èµ–ç®¡ç†å˜å¾—æ›´åŠ ç®€å•ã€‚ä»£ç ç”Ÿæˆè„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†å·¥ä½œåŒºé…ç½®ã€‚

#### **è‡ªåŠ¨ä¾èµ–ç®¡ç†**
```bash
# ç”Ÿæˆä»£ç æ—¶è‡ªåŠ¨è®¾ç½®å·¥ä½œåŒºå’Œä¾èµ– (æ¨è)
./scripts/gen-code.sh appuser all

# æ‰‹åŠ¨ç®¡ç†å·¥ä½œåŒºå’Œä¾èµ–
./scripts/gen-code.sh appuser tidy      # æ‰§è¡Œ go mod tidy åè‡ªåŠ¨è®¾ç½®å·¥ä½œåŒº
./scripts/gen-code.sh appuser workspace # å•ç‹¬è®¾ç½®å·¥ä½œåŒº

# æ‰¹é‡æ“ä½œ
./scripts/gen-code.sh all tidy          # ä¸ºæ‰€æœ‰æœåŠ¡è®¾ç½®å·¥ä½œåŒº
./scripts/gen-code.sh all workspace     # ä¸ºæ‰€æœ‰æœåŠ¡è®¾ç½®å·¥ä½œåŒº
```

#### **æ‰‹åŠ¨å·¥ä½œåŒºæ“ä½œ**
å¦‚éœ€æ‰‹åŠ¨ç®¡ç†å·¥ä½œåŒºï¼š
```bash
# è¿›å…¥æœåŠ¡çš„cmdç›®å½•
cd app/appuser/cmd

# åˆå§‹åŒ–å·¥ä½œåŒº
go work init

# æ·»åŠ æ¨¡å—
go work use api rpc model

# åŒæ­¥ä¾èµ–
go work sync

# éªŒè¯å·¥ä½œåŒº
go list -m all
```

#### **å¸¸è§é—®é¢˜è§£å†³**
- **ç¼–è¯‘é”™è¯¯**ï¼šç¡®ä¿åœ¨ `cmd` ç›®å½•ä¸‹è¿è¡Œå‘½ä»¤
- **ä¾èµ–é—®é¢˜**ï¼šè¿è¡Œ `go work sync` åŒæ­¥ä¾èµ–
- **IDE é—®é¢˜**ï¼šé‡å¯ IDE æˆ–é‡æ–°åŠ è½½å·¥ä½œåŒº

## 3. Kubernetes éƒ¨ç½²ç­–ç•¥ (æœ€ä½³å®è·µ)

åœ¨ Kubernetes ç¯å¢ƒä¸­ï¼Œ**å¼ºçƒˆæ¨èå°† API å’Œ RPC åˆ†å¼€æ‰“åŒ…ã€åˆ†ç¦»éƒ¨ç½²**ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªå¾®æœåŠ¡åˆ›å»ºä¸€ä¸ª `docker` ç›®å½•æ¥å­˜æ”¾å…¶ `Dockerfile`ã€‚

### 3.1 æ–‡ä»¶ç»“æ„è°ƒæ•´

```
app/appuser/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ rpc/
â”‚   â””â”€â”€ model/
â”œâ”€â”€ docker/                     <-- æ–°å¢
â”‚   â”œâ”€â”€ api.Dockerfile          <-- æœ¬åœ°æ„å»º (è½»é‡çº§)
â”‚   â”œâ”€â”€ rpc.Dockerfile          <-- æœ¬åœ°æ„å»º (è½»é‡çº§)
â”‚   â”œâ”€â”€ api.build.Dockerfile    <-- å®¹å™¨å†…æ„å»º (CI/CD)
â”‚   â”œâ”€â”€ rpc.build.Dockerfile    <-- å®¹å™¨å†…æ„å»º (CI/CD)
â”‚   â””â”€â”€ README.md               <-- Docker æ„å»ºæŒ‡å—
â”œâ”€â”€ k8s/                        <-- æ–°å¢
â”‚   â”œâ”€â”€ appuser-deployment.yaml <-- K8s éƒ¨ç½²é…ç½®
â”‚   â””â”€â”€ README.md               <-- K8s éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ build.sh                    <-- æ–°å¢ï¼šä¸€é”®æ„å»ºéƒ¨ç½²è„šæœ¬
â”œâ”€â”€ appuser-api.api
â”œâ”€â”€ appuser-rpc.proto
â””â”€â”€ appuser.sql
```

### 3.2 ä¸ºä»€ä¹ˆåˆ†ç¦»éƒ¨ç½²ï¼Ÿ

| ç‰¹æ€§ | åˆ†ç¦»éƒ¨ç½² (æ¨è) | åˆå¹¶éƒ¨ç½² (ä¸æ¨è) |
| :--- | :--- | :--- |
| **ç‹¬ç«‹æ‰©å±•** | âœ… API å’Œ RPC å¯æ ¹æ®è´Ÿè½½ç‹¬ç«‹æ‰©å±• | âŒ åªèƒ½æ•´ä½“æ‰©å±•ï¼Œæµªè´¹èµ„æº |
| **èµ„æºä¼˜åŒ–** | âœ… å¯ä¸º API/RPC é…ç½®ä¸åŒèµ„æºé™åˆ¶ | âŒ èµ„æºé…ç½®ä¸ç²¾ç¡® |
| **æ•…éšœéš”ç¦»** | âœ… API å´©æºƒä¸å½±å“ RPC | âŒ ä»»æ„ä¸€ä¸ªå´©æºƒå¯¼è‡´æ•´ä¸ª Pod å¤±è´¥ |
| **ç‹¬ç«‹å‘å¸ƒ** | âœ… å¯å•ç‹¬æ›´æ–° API æˆ– RPCï¼Œå‘å¸ƒçµæ´» | âŒ ä»»ä½•å°ä¿®æ”¹éƒ½éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªé•œåƒ |

### 3.3 Dockerfile æ„å»ºç­–ç•¥ (åŒæ¨¡å¼æœ€ä½³å®è·µ)

> **å®è·µç»éªŒ**: ä¸ºäº†å¹³è¡¡å¼€å‘æ•ˆç‡å’Œç”Ÿäº§ç¯å¢ƒçš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨**åŒæ¨¡å¼æ„å»º**ç­–ç•¥ã€‚

| æ„å»ºæ¨¡å¼ | Dockerfile | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- | :--- |
| **æœ¬åœ°æ„å»º** | `api.Dockerfile` | **æé€Ÿ**ï¼Œåˆ©ç”¨æœ¬åœ° Go ç¼“å­˜ | ä¾èµ–æœ¬åœ° Go ç¯å¢ƒ | **æ—¥å¸¸å¼€å‘** |
| **å®¹å™¨æ„å»º** | `api.build.Dockerfile` | **ç¯å¢ƒéš”ç¦»**ï¼Œæ„å»ºå¯å¤ç° | è¾ƒæ…¢ï¼Œæ—  Go ç¼“å­˜ | **CI/CD, ç”Ÿäº§** |

---

#### **æ¨¡å¼ä¸€ï¼šæœ¬åœ°æ„å»º Dockerfile (å¼€å‘æ¨è)**
è¿™ç§æ¨¡å¼çš„ `Dockerfile` æåº¦è½»é‡ï¼Œå®ƒå‡è®¾äºŒè¿›åˆ¶æ–‡ä»¶å·²åœ¨æœ¬åœ°ï¼ˆæˆ– CI çš„ä¸Šä¸€ä¸ªé˜¶æ®µï¼‰æ„å»ºå¥½ã€‚å®¹å™¨åªè´Ÿè´£æ‰“åŒ…å’Œè¿è¡Œã€‚

-   **`app/appuser/docker/api.Dockerfile`**:
    ```dockerfile
    # API æœåŠ¡ Dockerfile (æœ¬åœ°æ„å»ºç‰ˆæœ¬)
    # å‡è®¾äºŒè¿›åˆ¶æ–‡ä»¶ 'appuser-api' å·²åœ¨é¡¹ç›®æ ¹ç›®å½•æ„å»ºå¥½
    FROM alpine:latest

    # å®‰è£…è¿è¡Œæ—¶ä¾èµ–å’Œè®¾ç½®æ—¶åŒº
    RUN apk add --no-cache ca-certificates tzdata \
        && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
        && echo "Asia/Shanghai" > /etc/timezone \
        && apk del tzdata

    # åˆ›å»ºé root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§
    RUN addgroup -g 1000 appuser && \
        adduser -D -s /bin/sh -u 1000 -G appuser appuser

    WORKDIR /app

    # å¤åˆ¶é¢„æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
    COPY appuser-api .
    COPY app/appuser/cmd/api/etc ./etc

    # è®¾ç½®æƒé™
    RUN chmod +x ./appuser-api && \
        chown -R appuser:appuser /app

    USER appuser
    EXPOSE 10001
    CMD ["./appuser-api", "-f", "etc/appuser.yaml"]
    ```
> `rpc.Dockerfile` ä¸æ­¤ç±»ä¼¼ï¼Œåªéœ€æ›¿æ¢ç›¸åº”çš„æ–‡ä»¶åã€‚

---

#### **æ¨¡å¼äºŒï¼šå®¹å™¨å†…æ„å»º Dockerfile (CI/CD æ¨è)**
è¿™ç§æ¨¡å¼çš„ `Dockerfile` åŒ…å«å®Œæ•´çš„æ„å»ºç¯å¢ƒï¼Œä»æºç å¼€å§‹ç¼–è¯‘ï¼Œä¿è¯äº†æ„å»ºç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚

-   **`app/appuser/docker/api.build.Dockerfile`**:
    ```dockerfile
    # API æœåŠ¡ Dockerfile (å®¹å™¨å†…æ„å»ºç‰ˆæœ¬)
    FROM golang:1.24-alpine AS builder

    # å›½å†…ç¯å¢ƒä¼˜åŒ–
    ENV GOPROXY=https://goproxy.cn,direct

    WORKDIR /app

    # 1. å¤åˆ¶æ‰€æœ‰ go.mod/go.sum, åˆ©ç”¨ä¾èµ–ç¼“å­˜
    COPY app/appuser/cmd/model/go.* ./app/appuser/cmd/model/
    COPY app/appuser/cmd/rpc/go.* ./app/appuser/cmd/rpc/
    COPY app/appuser/cmd/api/go.* ./app/appuser/cmd/api/

    # 2. åœ¨ API æ¨¡å—ç›®å½•ä¸­ä¸‹è½½ä¾èµ–
    WORKDIR /app/app/appuser/cmd/api
    RUN go mod tidy

    # 3. å¤åˆ¶æœåŠ¡æºç 
    WORKDIR /app
    COPY app/appuser/ ./app/appuser/

    # 4. æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
    WORKDIR /app/app/appuser/cmd/api
    RUN CGO_ENABLED=0 GOOS=linux go build -o /app/appuser-api .

    # --- è¿è¡Œé˜¶æ®µ ---
    FROM alpine:latest
    WORKDIR /app
    COPY --from=builder /app/appuser-api .
    COPY app/appuser/cmd/api/etc /app/etc
    EXPOSE 10001
    CMD ["./appuser-api", "-f", "etc/appuser.yaml"]
    ```

### 3.4 Kubernetes YAML æ¨¡æ¿
> ä½äº `app/appuser/k8s/appuser-deployment.yaml`

è¯¥æ–‡ä»¶å®šä¹‰äº†ç‹¬ç«‹çš„ `Deployment`ã€`Service` å’Œ `ConfigMap` for API å’Œ RPCï¼Œå¹¶é€šè¿‡ `Ingress` å¯¹å¤–æš´éœ² API æœåŠ¡ã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†åŒ–éƒ¨ç½²é…ç½®ã€‚

### 3.5 è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬
> ä½äº `app/appuser/build.sh`

è¯¥è„šæœ¬å®ç°äº†è‡ªåŠ¨åŒ–æ„å»º Docker é•œåƒã€æ¨é€åˆ°é•œåƒä»“åº“ä»¥åŠéƒ¨ç½²åˆ° Kubernetes çš„å®Œæ•´ CI/CD æµç¨‹ã€‚

- **`app/appuser/build.sh` ç¤ºä¾‹**:
  ```bash
  #!/bin/bash
  set -e

  # æœåŠ¡åç§°ã€é•œåƒä»“åº“ã€ç‰ˆæœ¬å·
  SERVICE_NAME="appuser"
  REGISTRY="registry.huinong.internal/huinong"
  VERSION=${1:-"latest"}
  
  # æ„å»ºæ¨¡å¼: local(é»˜è®¤) æˆ– docker
  BUILD_MODE=${BUILD_MODE:-"local"}

  # --- Helper Functions ---
  log_step() { echo -e "\n\e[34m>>> $1\e[0m"; }
  log_info() { echo "    $1"; }

  # --- Build Logic ---
  
  # 1. æœ¬åœ°æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ (ä»…åœ¨ local æ¨¡å¼ä¸‹)
  build_binaries() {
      log_step "Building binaries locally for $SERVICE_NAME..."
      export CGO_ENABLED=0 GOOS=linux GOARCH=amd64

      log_info "Building API binary..."
      (cd app/$SERVICE_NAME/cmd/api && go build -ldflags="-s -w" -o ../../../../$SERVICE_NAME-api .)

      log_info "Building RPC binary..."
      (cd app/$SERVICE_NAME/cmd/rpc && go build -ldflags="-s -w" -o ../../../../$SERVICE_NAME-rpc .)
      
      log_info "Binaries created in project root."
  }

  # 2. æ„å»º Docker é•œåƒ
  build_images() {
      log_step "Building Docker images for $SERVICE_NAME:$VERSION (Mode: $BUILD_MODE)"

      if [ "$BUILD_MODE" = "local" ]; then
          build_binaries
          log_info "Building images with local binaries..."
          docker build -f ./app/$SERVICE_NAME/docker/api.Dockerfile -t $REGISTRY/$SERVICE_NAME-api:$VERSION .
          docker build -f ./app/$SERVICE_NAME/docker/rpc.Dockerfile -t $REGISTRY/$SERVICE_NAME-rpc:$VERSION .
          
          log_info "Cleaning up local binaries..."
          rm -f $SERVICE_NAME-api $SERVICE_NAME-rpc
      else
          log_info "Building images using in-container build..."
          docker build -f ./app/$SERVICE_NAME/docker/api.build.Dockerfile -t $REGISTRY/$SERVICE_NAME-api:$VERSION .
          docker build -f ./app/$SERVICE_NAME/docker/rpc.build.Dockerfile -t $REGISTRY/$SERVICE_NAME-rpc:$VERSION .
      fi
      
      log_info "Docker images built successfully!"
  }

  # --- Main Execution ---
  
  build_images
  # åœ¨æ­¤æ·»åŠ  push å’Œ deploy é€»è¾‘
  
  echo -e "\n\e[32m>>> Build completed for $SERVICE_NAME:$VERSION\e[0m"
  ```
  > **ä½¿ç”¨æ–¹æ³•**:  
  > `BUILD_MODE=local ./build.sh v1.0.0` (æœ¬åœ°æ„å»º)  
  > `BUILD_MODE=docker ./build.sh v1.0.0` (å®¹å™¨æ„å»º)

> **æ³¨æ„**ï¼šæ„å»ºå‘½ä»¤ `docker build` çš„ä¸Šä¸‹æ–‡ (`.`) æ˜¯é¡¹ç›®æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯ `app/appuser` ç›®å½•ã€‚

---

## 4. AppUser æ¨¡å—éƒ¨ç½²ä¸ä½¿ç”¨

### 4.1 å¿«é€Ÿå¯åŠ¨

#### **æœ¬åœ°å¼€å‘ç¯å¢ƒ**
```bash
# 1. å¯åŠ¨ RPC æœåŠ¡
cd app/appuser/cmd/rpc
go run appuserrpc.go -f etc/appuserrpc.yaml

# 2. å¯åŠ¨ API æœåŠ¡  
cd app/appuser/cmd/api
go run appuser.go -f etc/appuser.yaml
```

#### **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**
```bash
# ä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²
cd app/appuser
./build.sh v1.0.0 deploy

# æˆ–åˆ†æ­¥æ‰§è¡Œ
./build.sh v1.0.0 build    # æ„å»ºé•œåƒ
./build.sh v1.0.0 push     # æ¨é€é•œåƒ
./build.sh v1.0.0 deploy   # éƒ¨ç½²åˆ° K8s
```

### 4.2 API ä½¿ç”¨ç¤ºä¾‹

#### **ç”¨æˆ·æ³¨å†Œ**
```bash
curl -X POST http://localhost:10001/api/v1/appuser/register \
  -H "Content-Type: application/json" \
  -d '{
    "account": "13800138000",
    "password": "123456",
    "name": "å¼ ä¸‰",
    "age": 25,
    "gender": 1
  }'
```

#### **è·å–ç”¨æˆ·ä¿¡æ¯**ï¼ˆéœ€è¦ JWTï¼‰
```bash
curl -X GET http://localhost:10001/api/v1/appuser/info \
  -H "Authorization: Bearer <jwt_token>"
```

#### **ä¿¡ç”¨è¯„åˆ†è®¡ç®—**
```bash
curl -X POST http://localhost:10001/api/v1/appuser/credit-score/calculate \
  -H "Authorization: Bearer <jwt_token>"
```

#### **é£é™©è¯„ä¼°**
```bash
curl -X POST http://localhost:10001/api/v1/appuser/assess-risk \
  -H "Authorization: Bearer <jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "application_type": "loan",
    "amount": 100000,
    "duration": 12,
    "purpose": "è´­è½¦"
  }'
```

### 4.3 æœåŠ¡ç›‘æ§

#### **å¥åº·æ£€æŸ¥**
- **API æœåŠ¡**: `http://localhost:10001/ping`
- **RPC æœåŠ¡**: é€šè¿‡ Consul å¥åº·æ£€æŸ¥
- **æ•°æ®åº“è¿æ¥**: é€šè¿‡åº”ç”¨æ—¥å¿—ç›‘æ§

#### **å…³é”®æŒ‡æ ‡**
- **QPS**: API è¯·æ±‚é‡ç»Ÿè®¡
- **å“åº”æ—¶é—´**: P95ã€P99 å»¶è¿Ÿç›‘æ§  
- **é”™è¯¯ç‡**: HTTP 4xx/5xx é”™è¯¯ç»Ÿè®¡
- **æ•°æ®åº“æ€§èƒ½**: æ…¢æŸ¥è¯¢ç›‘æ§

### 4.4 æ‰©å±•æŒ‡å—

#### **æ·»åŠ æ–°æ¥å£**
1. åœ¨ `appuser-api.api` ä¸­å®šä¹‰ HTTP æ¥å£
2. åœ¨ `appuser-rpc.proto` ä¸­å®šä¹‰ RPC æ–¹æ³•
3. è¿è¡Œ `./scripts/gen-code.sh appuser api` é‡æ–°ç”Ÿæˆä»£ç 
4. å®ç° Logic å±‚ä¸šåŠ¡é€»è¾‘

#### **æ·»åŠ æ–°æ•°æ®è¡¨**
1. åœ¨ `appuser.sql` ä¸­æ·»åŠ è¡¨ç»“æ„
2. è¿è¡Œ `./scripts/gen-code.sh appuser model` ç”Ÿæˆ Model ä»£ç 
3. åœ¨ `servicecontext.go` ä¸­æ³¨å†Œæ–°çš„ Model

#### **æ€§èƒ½ä¼˜åŒ–**
- **ç¼“å­˜ç­–ç•¥**: go-zero è‡ªåŠ¨ç¼“å­˜ + Redis æ‰‹åŠ¨ç¼“å­˜
- **æ•°æ®åº“ä¼˜åŒ–**: ç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–ã€è¯»å†™åˆ†ç¦»
- **æœåŠ¡æ‹†åˆ†**: æŒ‰ä¸šåŠ¡åŸŸè¿›ä¸€æ­¥æ‹†åˆ†å¾®æœåŠ¡

---

## 5. å¾®æœåŠ¡ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ

> **é‡è¦æé†’**ï¼šæœ¬ç« èŠ‚æ€»ç»“äº†åœ¨å®é™…å¼€å‘ä¸­å®¹æ˜“çŠ¯çš„é”™è¯¯å’Œæ­£ç¡®çš„æ¶æ„å®è·µï¼Œæ˜¯è¡€æ³ªæ•™è®­çš„æ€»ç»“ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªã€‚

### 5.1 æœåŠ¡è°ƒç”¨çš„é»„é‡‘æ³•åˆ™

#### âŒ é”™è¯¯å®è·µï¼šä»£ç å±‚é¢çš„ç›´æ¥ä¾èµ–

**é”™è¯¯ç¤ºä¾‹**ï¼š
```go
// âŒ é”™è¯¯ï¼šAuth RPC ç›´æ¥ä¾èµ–å…¶ä»–æœåŠ¡çš„ä»£ç æ¨¡å—
// app/auth/cmd/rpc/go.mod
require (
    appuser-rpc v0.0.0-00010101000000-000000000000  // âŒ é”™è¯¯
    oauser-rpc v0.0.0-00010101000000-000000000000   // âŒ é”™è¯¯
)
replace appuser-rpc => ../../appuser/cmd/rpc        // âŒ é”™è¯¯
replace oauser-rpc => ../../oauser/cmd/rpc          // âŒ é”™è¯¯
```

**é—®é¢˜åˆ†æ**ï¼š
- è¿™æ ·åšä¼šé€ æˆæœåŠ¡é—´çš„å¼ºè€¦åˆ
- éƒ¨ç½²æ—¶å¿…é¡»åŒæ—¶éƒ¨ç½²æ‰€æœ‰ç›¸å…³æœåŠ¡
- æ— æ³•å®ç°ç‹¬ç«‹æ‰©å±•å’Œæ•…éšœéš”ç¦»
- è¿èƒŒäº†å¾®æœåŠ¡çš„åŸºæœ¬åŸåˆ™

#### âœ… æ­£ç¡®å®è·µï¼šé€šè¿‡æœåŠ¡å‘ç°çš„æ¾è€¦åˆè°ƒç”¨

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```go
// âœ… æ­£ç¡®ï¼šAuth RPC é€šè¿‡æœåŠ¡å‘ç°è°ƒç”¨å…¶ä»–æœåŠ¡
// app/auth/cmd/rpc/go.mod
require (
    github.com/zeromicro/go-zero v1.8.4
    github.com/zeromicro/zero-contrib/zrpc/registry/consul v0.0.0-20231030135404-af9ae855016f
    // ä¸ç›´æ¥ä¾èµ–å…¶ä»–æœåŠ¡çš„ä»£ç 
)
```

```yaml
# âœ… æ­£ç¡®ï¼šé€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šæœåŠ¡å‘ç°
# app/auth/cmd/rpc/etc/authrpc.yaml
AppUserRpc:
  Target: consul://consul.huinong.internal/appuserrpc.rpc
OaUserRpc:
  Target: consul://consul.huinong.internal/oauserrpc.rpc
```

### 5.2 API å±‚è°ƒç”¨åŸåˆ™

#### âŒ é”™è¯¯å®è·µï¼šAPI è·¨æœåŠ¡è°ƒç”¨

```go
// âŒ é”™è¯¯ï¼šAuth API ç›´æ¥è°ƒç”¨å…¶ä»–æœåŠ¡çš„ RPC
type ServiceContext struct {
    Config     config.Config
    AuthRpc    authclient.Auth      // âœ… æ­£ç¡®ï¼šè°ƒç”¨è‡ªå·±çš„ RPC
    AppUserRpc appuserclient.AppUser // âŒ é”™è¯¯ï¼šè·¨æœåŠ¡è°ƒç”¨
    OaUserRpc  oauserclient.OaUser   // âŒ é”™è¯¯ï¼šè·¨æœåŠ¡è°ƒç”¨
}
```

#### âœ… æ­£ç¡®å®è·µï¼šAPI åªè°ƒç”¨è‡ªå·±çš„ RPC

```go
// âœ… æ­£ç¡®ï¼šAuth API åªè°ƒç”¨è‡ªå·±çš„ RPC
type ServiceContext struct {
    Config  config.Config
    AuthRpc authclient.Auth  // âœ… åªè°ƒç”¨è‡ªå·±çš„ RPC
}
```

**è°ƒç”¨æµç¨‹**ï¼š
```
1. å®¢æˆ·ç«¯è¯·æ±‚ â†’ Auth API
2. Auth API â†’ Auth RPC (è‡ªå·±çš„æœåŠ¡)
3. Auth RPC â†’ é€šè¿‡æœåŠ¡å‘ç° â†’ AppUser RPC (éªŒè¯ç”¨æˆ·)
4. Auth RPC â†’ é€šè¿‡æœåŠ¡å‘ç° â†’ OAUser RPC (éªŒè¯ç®¡ç†å‘˜)
```

### 5.3 Go Workspace ä¾èµ–é…ç½®æ ‡å‡† (æ–°æ–¹æ¡ˆ)

**é‡è¦å‡çº§**ï¼šæˆ‘ä»¬ç°åœ¨ä½¿ç”¨ **Go Workspace** æ›¿ä»£ `replace` æŒ‡ä»¤è¿›è¡Œæœ¬åœ°æ¨¡å—ç®¡ç†ã€‚

#### 5.3.1 å·¥ä½œåŒºé…ç½®

```go
// app/*/cmd/go.work - å·¥ä½œåŒºé…ç½®æ–‡ä»¶ (è‡ªåŠ¨ç”Ÿæˆ)
go 1.24.3

use (
    ./api
    ./rpc  
    ./model
)

// æ³¨æ„ï¼š
// 1. go.work æ–‡ä»¶ä½äº app/*/cmd/ ç›®å½•ä¸‹
// 2. è‡ªåŠ¨åŒ…å«å½“å‰æœåŠ¡çš„æ‰€æœ‰æ¨¡å—
// 3. é€šå¸¸ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ (.gitignore)
```

#### 5.3.2 Model æ¨¡å—ä¾èµ– (æ— å˜åŒ–)

```go
// app/*/cmd/model/go.mod - æ•°æ®è®¿é—®å±‚ï¼Œæ— éœ€ä¾èµ–å…¶ä»–ä¸šåŠ¡æ¨¡å—
module model

go 1.24.3

require github.com/zeromicro/go-zero v1.8.4
// æ— å…¶ä»–ä¸šåŠ¡æ¨¡å—ä¾èµ–
```

#### 5.3.3 RPC æ¨¡å—ä¾èµ– (ç®€åŒ–ç‰ˆ)

```go
// app/*/cmd/rpc/go.mod - ä¸šåŠ¡é€»è¾‘å±‚ï¼Œé€šè¿‡å·¥ä½œåŒºä¾èµ– model
module rpc

go 1.24.3

require (
    github.com/zeromicro/go-zero v1.8.4
    github.com/zeromicro/zero-contrib/zrpc/registry/consul v0.0.0-20231030135404-af9ae855016f
    google.golang.org/grpc v1.73.0
    google.golang.org/protobuf v1.36.6
    model v0.0.0  // âœ… é€šè¿‡å·¥ä½œåŒºè‡ªåŠ¨è§£æï¼Œæ— éœ€ä¼ªç‰ˆæœ¬å·
)

// âœ… æ— éœ€ replace æŒ‡ä»¤ï¼å·¥ä½œåŒºè‡ªåŠ¨å¤„ç†æœ¬åœ°ä¾èµ–
```

#### 5.3.4 API æ¨¡å—ä¾èµ– (ç®€åŒ–ç‰ˆ)

```go
// app/*/cmd/api/go.mod - åè®®è½¬æ¢å±‚ï¼Œé€šè¿‡å·¥ä½œåŒºä¾èµ– rpc
module api

go 1.24.3

require (
    github.com/zeromicro/go-zero v1.8.4
    github.com/zeromicro/zero-contrib/zrpc/registry/consul v0.0.0-20231030135404-af9ae855016f
    rpc v0.0.0  // âœ… é€šè¿‡å·¥ä½œåŒºè‡ªåŠ¨è§£æï¼Œæ— éœ€ä¼ªç‰ˆæœ¬å·
)

// âœ… æ— éœ€ replace æŒ‡ä»¤ï¼å·¥ä½œåŒºè‡ªåŠ¨å¤„ç†æœ¬åœ°ä¾èµ–
```

#### 5.3.5 å·¥ä½œåŒºç®¡ç†å‘½ä»¤

```bash
# è‡ªåŠ¨è®¾ç½®å·¥ä½œåŒº (æ¨è)
./scripts/gen-code.sh appuser workspace

# æ‰‹åŠ¨å·¥ä½œåŒºæ“ä½œ
cd app/appuser/cmd
go work init              # åˆå§‹åŒ–å·¥ä½œåŒº
go work use api rpc model # æ·»åŠ æ¨¡å—
go work sync              # åŒæ­¥ä¾èµ–
go list -m all            # æŸ¥çœ‹æ‰€æœ‰æ¨¡å—

# æ„å»ºå’Œæµ‹è¯•
go build ./api            # æ„å»ºAPIæ¨¡å—
go build ./rpc            # æ„å»ºRPCæ¨¡å—
go test ./...             # æµ‹è¯•æ‰€æœ‰æ¨¡å—
```

### 5.4 æœåŠ¡é—´é€šä¿¡æ¶æ„å›¾

```mermaid
graph TD
    subgraph "æ­£ç¡®çš„å¾®æœåŠ¡è°ƒç”¨æ¶æ„"
        subgraph "Auth æœåŠ¡"
            AuthAPI[Auth API]
            AuthRPC[Auth RPC]
            AuthAPI --> AuthRPC
        end
        
        subgraph "AppUser æœåŠ¡"
            AppUserAPI[AppUser API] 
            AppUserRPC[AppUser RPC]
            AppUserModel[AppUser Model]
            AppUserAPI --> AppUserRPC
            AppUserRPC --> AppUserModel
        end
        
        subgraph "OAUser æœåŠ¡"
            OAUserAPI[OAUser API]
            OAUserRPC[OAUser RPC] 
            OAUserModel[OAUser Model]
            OAUserAPI --> OAUserRPC
            OAUserRPC --> OAUserModel
        end
        
        subgraph "åŸºç¡€è®¾æ–½"
            Consul[Consul æœåŠ¡å‘ç°]
            MySQL[(MySQL)]
            Redis[(Redis)]
        end
    end
    
    %% æ­£ç¡®çš„è°ƒç”¨å…³ç³»
    AuthRPC -.é€šè¿‡æœåŠ¡å‘ç°.-> Consul
    AppUserRPC -.æœåŠ¡æ³¨å†Œ.-> Consul  
    OAUserRPC -.æœåŠ¡æ³¨å†Œ.-> Consul
    
    AuthRPC -.RPCè°ƒç”¨.-> AppUserRPC
    AuthRPC -.RPCè°ƒç”¨.-> OAUserRPC
    
    AppUserModel --> MySQL
    OAUserModel --> MySQL
    AuthRPC --> Redis
    
    %% æ ·å¼
    classDef api fill:#cde4ff,stroke:#333
    classDef rpc fill:#d5e8d4,stroke:#333  
    classDef model fill:#ffe6cc,stroke:#333
    classDef infra fill:#f9f9f9,stroke:#666
    
    class AuthAPI,AppUserAPI,OAUserAPI api
    class AuthRPC,AppUserRPC,OAUserRPC rpc
    class AppUserModel,OAUserModel model
    class Consul,MySQL,Redis infra
```

### 5.5 å¸¸è§é”™è¯¯æ±‡æ€»

#### é”™è¯¯1ï¼šå¾ªç¯ä¾èµ–
```bash
# âŒ é”™è¯¯ç°è±¡
package model is not in std (/root/sdk/go1.24.3/src/model)
package rpc/oauserclient is not in std (/root/sdk/go1.24.3/src/rpc/oauserclient)
```

**åŸå› **ï¼šç¼ºå°‘ `replace` æŒ‡ä»¤æˆ–è·¯å¾„é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è¿è¡Œè„šæœ¬ä¿®å¤æ‰€æœ‰ä¾èµ–
./scripts/gen-code.sh all tidy
```

#### é”™è¯¯2ï¼šæœåŠ¡å¼ºè€¦åˆ
- **ç°è±¡**ï¼šä¸€ä¸ªæœåŠ¡æ— æ³•ç‹¬ç«‹å¯åŠ¨
- **åŸå› **ï¼šåœ¨ go.mod ä¸­ç›´æ¥ä¾èµ–å…¶ä»–æœåŠ¡ä»£ç 
- **è§£å†³**ï¼šç§»é™¤ä»£ç ä¾èµ–ï¼Œæ”¹ç”¨æœåŠ¡å‘ç°

#### é”™è¯¯3ï¼šè¿èƒŒå•ä¸€èŒè´£
- **ç°è±¡**ï¼šAPI ç›´æ¥è°ƒç”¨å¤šä¸ª RPC æœåŠ¡
- **åŸå› **ï¼šæ²¡æœ‰éµå¾ª"API åªè°ƒç”¨è‡ªå·± RPC"çš„åŸåˆ™  
- **è§£å†³**ï¼šå°†è·¨æœåŠ¡è°ƒç”¨é€»è¾‘ä¸‹æ²‰åˆ° RPC å±‚

### 5.6 ä¾èµ–ç®¡ç†æ£€æŸ¥æ¸…å• (Go Workspaceç‰ˆ)

åœ¨å®ŒæˆæœåŠ¡å¼€å‘åï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] **å·¥ä½œåŒºé…ç½®**ï¼š`go.work` æ–‡ä»¶å·²æ­£ç¡®ç”Ÿæˆå¹¶åŒ…å«æ‰€æœ‰æ¨¡å—
- [ ] **API æ¨¡å—**ï¼šåªä¾èµ–è‡ªå·±çš„ RPCï¼Œæ—  `replace` æŒ‡ä»¤
- [ ] **RPC æ¨¡å—**ï¼šåªä¾èµ–è‡ªå·±çš„ Modelï¼Œé€šè¿‡æœåŠ¡å‘ç°è°ƒç”¨å…¶ä»– RPC
- [ ] **Model æ¨¡å—**ï¼šåªä¾èµ– go-zero æ¡†æ¶ï¼Œæ— å…¶ä»–ä¸šåŠ¡ä¾èµ–
- [ ] **é…ç½®æ–‡ä»¶**ï¼šRPC å®¢æˆ·ç«¯ä½¿ç”¨ Consul æœåŠ¡å‘ç°åœ°å€
- [ ] **ç¼–è¯‘æµ‹è¯•**ï¼šåœ¨ `cmd` ç›®å½•ä¸‹ `go run ./api/xxx.go --help` èƒ½æ­£å¸¸è¿è¡Œ
- [ ] **å·¥ä½œåŒºæµ‹è¯•**ï¼š`go work sync` å’Œ `go list -m all` æ­£å¸¸æ‰§è¡Œ
- [ ] **æ¶æ„åŸåˆ™**ï¼šéµå¾ªå•ä¸€èŒè´£ï¼ŒæœåŠ¡è¾¹ç•Œæ¸…æ™°

### 5.7 æ•…éšœæ’æŸ¥æŒ‡å— (Go Workspaceç‰ˆ)

#### é—®é¢˜ï¼šç¼–è¯‘é”™è¯¯ "package xxx is not in std"
1. **æ£€æŸ¥å·¥ä½œåŒº**ï¼šç¡®ä¿åœ¨ `cmd` ç›®å½•ä¸‹ä¸”å­˜åœ¨ `go.work` æ–‡ä»¶
2. **é‡æ–°è®¾ç½®å·¥ä½œåŒº**ï¼šè¿è¡Œ `./scripts/gen-code.sh servicename workspace`
3. **æ‰‹åŠ¨åŒæ­¥ä¾èµ–**ï¼š`cd app/servicename/cmd && go work sync`
4. **æ£€æŸ¥æ¨¡å—è·¯å¾„**ï¼šç¡®ä¿ go.mod ä¸­çš„æ¨¡å—ä¾èµ–åç§°æ­£ç¡®

#### é—®é¢˜ï¼šå·¥ä½œåŒºç›¸å…³é”™è¯¯
1. **åˆå§‹åŒ–å·¥ä½œåŒº**ï¼š`go work init` ç„¶å `go work use api rpc model`
2. **åŒæ­¥ä¾èµ–**ï¼š`go work sync` è§£å†³ç‰ˆæœ¬å†²çª
3. **éªŒè¯å·¥ä½œåŒº**ï¼š`go list -m all` æŸ¥çœ‹æ‰€æœ‰æ¨¡å—çŠ¶æ€
4. **é‡ç½®å·¥ä½œåŒº**ï¼šåˆ é™¤ `go.work` æ–‡ä»¶åé‡æ–°ç”Ÿæˆ

#### é—®é¢˜ï¼šIDE æ— æ³•è¯†åˆ«å·¥ä½œåŒº
1. **é‡å¯IDE**ï¼šé‡æ–°åŠ è½½å·¥ä½œåŒºé…ç½®
2. **æ‰“å¼€æ­£ç¡®ç›®å½•**ï¼šåœ¨ IDE ä¸­æ‰“å¼€ `app/servicename/cmd` ç›®å½•
3. **Goç‰ˆæœ¬**ï¼šç¡®ä¿ä½¿ç”¨ Go 1.18+ ä»¥æ”¯æŒå·¥ä½œåŒºåŠŸèƒ½

#### é—®é¢˜ï¼šæœåŠ¡å¯åŠ¨æ—¶æ‰¾ä¸åˆ°å…¶ä»–æœåŠ¡
1. æ£€æŸ¥ Consul æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æ£€æŸ¥è¢«è°ƒç”¨æœåŠ¡æ˜¯å¦å·²æ³¨å†Œåˆ° Consul
3. æ£€æŸ¥æœåŠ¡å‘ç°é…ç½®æ˜¯å¦æ­£ç¡®

#### é—®é¢˜ï¼šRPC è°ƒç”¨å¤±è´¥
1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
2. æ£€æŸ¥æœåŠ¡æ³¨å†Œçš„ Key æ˜¯å¦ä¸€è‡´
3. æ£€æŸ¥ Consul Token é…ç½®

---

**éµå¾ªæœ¬æŒ‡å—ï¼Œå¯ä»¥ç¡®ä¿å›¢é˜Ÿæ‰€æœ‰æˆå‘˜ä»¥ç»Ÿä¸€ã€é«˜æ•ˆã€å¯é çš„æ–¹å¼å¼€å‘å’Œäº¤ä»˜å¾®æœåŠ¡ã€‚ç‰¹åˆ«æ˜¯ç¬¬5ç« çš„ä¾èµ–ç®¡ç†å®è·µï¼Œæ˜¯é¿å…æ¶æ„é™·é˜±çš„é‡è¦ä¿éšœã€‚**
