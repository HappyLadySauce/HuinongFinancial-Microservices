# ç†”æ–­å™¨å®æ–½å¿«é€Ÿæ¨¡æ¿

## ğŸ“‹ å¸¸ç”¨ä»£ç æ¨¡æ¿

### 1. APIå±‚è°ƒç”¨RPCæ¨¡æ¿

#### æ¨¡æ¿Aï¼šæœ‰è¿”å›å€¼çš„RPCè°ƒç”¨

```go
// ğŸ“‹ æ­¥éª¤1ï¼šæ·»åŠ import
import (
    "api/internal/breaker"  // æ·»åŠ è¿™è¡Œ
)

// ğŸ“‹ æ­¥éª¤2ï¼šæ›¿æ¢RPCè°ƒç”¨
// åŸå§‹ä»£ç ï¼š
rpcResp, err := l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
    Field: req.Field,
})

// ç†”æ–­å™¨ä»£ç ï¼š
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "service-name-rpc", func() (*client.Response, error) {
    return l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
        Field: req.Field,
    })
}, breaker.IsAcceptableError)
```

#### æ¨¡æ¿Bï¼šæ— è¿”å›å€¼çš„RPCè°ƒç”¨

```go
// åŸå§‹ä»£ç ï¼š
_, err = l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
    Field: req.Field,
})

// ç†”æ–­å™¨ä»£ç ï¼š
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "service-name-rpc", func() (*client.Response, error) {
    return l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
        Field: req.Field,
    })
}, breaker.IsAcceptableError)
```

### 2. RPCå±‚è°ƒç”¨å…¶ä»–RPCæ¨¡æ¿

```go
// ğŸ“‹ æ­¥éª¤1ï¼šæ·»åŠ import
import (
    "rpc/internal/breaker"  // æ·»åŠ è¿™è¡Œ
)

// ğŸ“‹ æ­¥éª¤2ï¼šæ›¿æ¢RPCè°ƒç”¨
// åŸå§‹ä»£ç ï¼š
userResp, err := l.svcCtx.AppUserClient.GetUserById(l.ctx, &appuserclient.GetUserByIdReq{
    UserId: in.UserId,
})

// ç†”æ–­å™¨ä»£ç ï¼š
userResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuserclient.GetUserInfoResp, error) {
    return l.svcCtx.AppUserClient.GetUserById(l.ctx, &appuserclient.GetUserByIdReq{
        UserId: in.UserId,
    })
}, breaker.IsAcceptableError)
```

### 3. å¸¦é‡è¯•çš„å…³é”®ä¸šåŠ¡è°ƒç”¨æ¨¡æ¿

```go
// å¯¹äºå…³é”®ä¸šåŠ¡ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
rpcResp, err := breaker.DoWithBreakerAndRetry(l.ctx, "service-name-rpc", func() (*client.Response, error) {
    return l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
        Field: req.Field,
    })
}, 3, time.Second) // æœ€å¤šé‡è¯•3æ¬¡ï¼Œæ¯æ¬¡é—´éš”1ç§’
```

## ğŸ”„ å…·ä½“æ¨¡å—å®æ–½æŒ‡å—

### AppUseræ¨¡å—

#### loginLogic.go âœ… å·²å®Œæˆ
```go
// å‚è€ƒå·²å®Œæˆçš„å®ç°
loginResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.LoginResp, error) {
    return l.svcCtx.AppUserRpc.Login(l.ctx, &appuser.LoginReq{
        Phone:    req.Phone,
        Password: req.Password,
    })
}, breaker.IsAcceptableError)
```

#### å…¶ä»–Logicæ–‡ä»¶æ¨¡æ¿
```go
// getUserByPhoneLogic.go
userResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.GetUserInfoResp, error) {
    return l.svcCtx.AppUserRpc.GetUserByPhone(l.ctx, &appuser.GetUserInfoReq{
        Phone: req.Phone,
    })
}, breaker.IsAcceptableError)

// updateUserInfoLogic.go  
updateResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.UpdateUserInfoResp, error) {
    return l.svcCtx.AppUserRpc.UpdateUserInfo(l.ctx, &appuser.UpdateUserInfoReq{
        UserInfo: rpcUserInfo,
    })
}, breaker.IsAcceptableError)

// deleteUserLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.DeleteUserResp, error) {
    return l.svcCtx.AppUserRpc.DeleteUser(l.ctx, &appuser.DeleteUserReq{
        Phone: req.Phone,
    })
}, breaker.IsAcceptableError)

// changePasswordLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.ChangePasswordResp, error) {
    return l.svcCtx.AppUserRpc.ChangePassword(l.ctx, &appuser.ChangePasswordReq{
        Phone:       req.Phone,
        OldPassword: req.OldPassword,
        NewPassword: req.NewPassword,
    })
}, breaker.IsAcceptableError)

// logoutLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.LogoutResp, error) {
    return l.svcCtx.AppUserRpc.Logout(l.ctx, &appuser.LogoutReq{})
}, breaker.IsAcceptableError)
```

### OaUseræ¨¡å—

```go
// loginLogic.go
loginResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.LoginResp, error) {
    return l.svcCtx.OaUserRpc.Login(l.ctx, &oauserclient.LoginReq{
        Phone:    req.Phone,
        Password: req.Password,
    })
}, breaker.IsAcceptableError)

// registerLogic.go
registerResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.RegisterResp, error) {
    return l.svcCtx.OaUserRpc.Register(l.ctx, &oauserclient.RegisterReq{
        Phone:    req.Phone,
        Password: req.Password,
        Role:     req.Role,
    })
}, breaker.IsAcceptableError)

// getUserByPhoneLogic.go
getUserResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.GetUserInfoResp, error) {
    return l.svcCtx.OaUserRpc.GetUserByPhone(l.ctx, &oauserclient.GetUserInfoReq{
        Phone: req.Phone,
    })
}, breaker.IsAcceptableError)

// updateUserStatusLogic.go
updateResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.UpdateUserStatusResp, error) {
    return l.svcCtx.OaUserRpc.UpdateUserStatus(l.ctx, &oauserclient.UpdateUserStatusReq{
        Phone:  req.Phone,
        Status: int32(req.Status),
    })
}, breaker.IsAcceptableError)
```

### Loanæ¨¡å—

```go
// getMyLoanApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.GetLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.GetLoanApplication(l.ctx, &loanclient.GetLoanApplicationReq{
        ApplicationId: applicationId,
    })
}, breaker.IsAcceptableError)

// updateMyLoanApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.UpdateLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.UpdateLoanApplication(l.ctx, &loanclient.UpdateLoanApplicationReq{
        ApplicationId: req.ApplicationId,
        Amount:        req.Amount,
        Duration:      req.Duration,
        Purpose:       req.Purpose,
    })
}, breaker.IsAcceptableError)

// listMyLoanApplicationsLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.ListLoanApplicationsResp, error) {
    return l.svcCtx.LoanRpc.ListLoanApplications(l.ctx, &loanclient.ListLoanApplicationsReq{
        UserId: userId,
        Page:   req.Page,
        Size:   req.Size,
    })
}, breaker.IsAcceptableError)

// approveLoanApplicationLogic.go (ç®¡ç†å‘˜å®¡æ‰¹)
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.ApproveLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.ApproveLoanApplication(l.ctx, &loanclient.ApproveLoanApplicationReq{
        ApplicationId:    req.ApplicationId,
        AuditorId:        auditorId,
        AuditorName:      auditorName,
        Action:           req.Action,
        Suggestions:      req.Suggestions,
        ApprovedAmount:   req.ApprovedAmount,
        ApprovedDuration: req.ApprovedDuration,
        InterestRate:     req.InterestRate,
    })
}, breaker.IsAcceptableError)
```

### Leaseæ¨¡å—

```go
// getMyLeaseApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "lease-rpc", func() (*leaseclient.GetLeaseApplicationResp, error) {
    return l.svcCtx.LeaseRpc.GetLeaseApplication(l.ctx, &leaseclient.GetLeaseApplicationReq{
        ApplicationId: applicationId,
    })
}, breaker.IsAcceptableError)

// updateMyLeaseApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "lease-rpc", func() (*leaseclient.UpdateLeaseApplicationResp, error) {
    return l.svcCtx.LeaseRpc.UpdateLeaseApplication(l.ctx, &leaseclient.UpdateLeaseApplicationReq{
        ApplicationId:   req.ApplicationId,
        Purpose:         req.Purpose,
        DeliveryAddress: req.DeliveryAddress,
        ContactPhone:    req.ContactPhone,
    })
}, breaker.IsAcceptableError)

// cancelMyLeaseApplicationLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "lease-rpc", func() (*leaseclient.CancelLeaseApplicationResp, error) {
    return l.svcCtx.LeaseRpc.CancelLeaseApplication(l.ctx, &leaseclient.CancelLeaseApplicationReq{
        ApplicationId: req.ApplicationId,
        Reason:        req.Reason,
    })
}, breaker.IsAcceptableError)
```

### LoanProductæ¨¡å—

```go
// getLoanProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.GetLoanProductResp, error) {
    return l.svcCtx.LoanProductRpc.GetLoanProduct(l.ctx, &loanproduct.GetLoanProductReq{
        Id: id,
    })
}, breaker.IsAcceptableError)

// updateLoanProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.UpdateLoanProductResp, error) {
    return l.svcCtx.LoanProductRpc.UpdateLoanProduct(l.ctx, &loanproduct.UpdateLoanProductReq{
        Id:           id,
        ProductCode:  req.ProductCode,
        Name:         req.Name,
        Type:         req.Type,
        MaxAmount:    req.MaxAmount,
        MinAmount:    req.MinAmount,
        MaxDuration:  req.MaxDuration,
        MinDuration:  req.MinDuration,
        InterestRate: req.InterestRate,
        Description:  req.Description,
    })
}, breaker.IsAcceptableError)

// deleteLoanProductLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.DeleteLoanProductResp, error) {
    return l.svcCtx.LoanProductRpc.DeleteLoanProduct(l.ctx, &loanproduct.DeleteLoanProductReq{
        Id: id,
    })
}, breaker.IsAcceptableError)

// listLoanProductsLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.ListLoanProductsResp, error) {
    return l.svcCtx.LoanProductRpc.ListLoanProducts(l.ctx, &loanproduct.ListLoanProductsReq{
        Page:   req.Page,
        Size:   req.Size,
        Status: req.Status,
    })
}, breaker.IsAcceptableError)
```

### LeaseProductæ¨¡å—

```go
// getLeaseProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "leaseproduct-rpc", func() (*leaseproductservice.GetLeaseProductResp, error) {
    return l.svcCtx.LeaseProductRpc.GetLeaseProduct(l.ctx, &leaseproductservice.GetLeaseProductReq{
        ProductCode: productCode,
    })
}, breaker.IsAcceptableError)

// createLeaseProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "leaseproduct-rpc", func() (*leaseproduct.CreateLeaseProductResp, error) {
    return l.svcCtx.LeaseProductRpc.CreateLeaseProduct(l.ctx, &leaseproduct.CreateLeaseProductReq{
        ProductCode:    req.ProductCode,
        Name:           req.Name,
        Type:           req.Type,
        Machinery:      req.Machinery,
        Brand:          req.Brand,
        Model:          req.Model,
        DailyRate:      req.DailyRate,
        Deposit:        req.Deposit,
        MaxDuration:    req.MaxDuration,
        MinDuration:    req.MinDuration,
        Description:    req.Description,
        InventoryCount: req.InventoryCount,
    })
}, breaker.IsAcceptableError)

// checkInventoryAvailabilityLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "leaseproduct-rpc", func() (*leaseproductservice.CheckInventoryAvailabilityResp, error) {
    return l.svcCtx.LeaseProductRpc.CheckInventoryAvailability(l.ctx, &leaseproductservice.CheckInventoryAvailabilityReq{
        ProductCode: req.ProductCode,
        Quantity:    req.Quantity,
        StartDate:   req.StartDate,
        EndDate:     req.EndDate,
    })
}, breaker.IsAcceptableError)
```

## ğŸ” æœåŠ¡åç§°æ˜ å°„è¡¨

| APIè°ƒç”¨çš„RPCæœåŠ¡ | ç†”æ–­å™¨æœåŠ¡å |
|------------------|-------------|
| AppUserRpc | `"appuser-rpc"` |
| OaUserRpc | `"oauser-rpc"` |
| LoanRpc | `"loan-rpc"` |
| LeaseRpc | `"lease-rpc"` |
| LoanProductRpc | `"loanproduct-rpc"` |
| LeaseProductRpc | `"leaseproduct-rpc"` |

## âš¡ å¿«é€Ÿæ›¿æ¢è„šæœ¬

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹sedå‘½ä»¤å¿«é€Ÿæ›¿æ¢ï¼š

```bash
# æ›¿æ¢ç®€å•çš„RPCè°ƒç”¨
sed -i 's/l\.svcCtx\.ServiceRpc\.Method/breaker.DoWithBreakerResultAcceptable(l.ctx, "service-rpc", func() (*Response, error) { return l.svcCtx.ServiceRpc.Method/g' file.go

# éœ€è¦æ‰‹åŠ¨æ·»åŠ é—­åŒ…ç»“å°¾å’Œé”™è¯¯å¤„ç†
```

## ğŸ“ å®æ–½æ£€æŸ¥æ¸…å•

- [ ] æ·»åŠ `"api/internal/breaker"`æˆ–`"rpc/internal/breaker"`å¯¼å…¥
- [ ] æ›¿æ¢æ‰€æœ‰RPCè°ƒç”¨ä¸ºç†”æ–­å™¨è°ƒç”¨
- [ ] ç¡®è®¤æœåŠ¡åç§°æ­£ç¡®æ˜ å°„
- [ ] ä¿æŒåŸæœ‰çš„é”™è¯¯å¤„ç†é€»è¾‘
- [ ] ç¼–è¯‘éªŒè¯æ— è¯­æ³•é”™è¯¯
- [ ] æµ‹è¯•éªŒè¯åŠŸèƒ½æ­£å¸¸

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **è¿”å›å€¼ç±»å‹åŒ¹é…**: ç¡®ä¿ç†”æ–­å™¨å‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¸åŸRPCè°ƒç”¨ä¸€è‡´
2. **é”™è¯¯å¤„ç†**: ä¿æŒåŸæœ‰çš„é”™è¯¯å¤„ç†é€»è¾‘
3. **ä¸Šä¸‹æ–‡ä¼ é€’**: ç¡®ä¿æ­£ç¡®ä¼ é€’context
4. **æœåŠ¡åç§°**: ä½¿ç”¨æ­£ç¡®çš„æœåŠ¡åç§°è¿›è¡Œç†”æ–­å™¨æ ‡è¯†
5. **å¯¼å…¥è·¯å¾„**: APIå±‚ä½¿ç”¨`"api/internal/breaker"`ï¼ŒRPCå±‚ä½¿ç”¨`"rpc/internal/breaker"`