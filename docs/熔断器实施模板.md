# 熔断器实施快速模板

## 📋 常用代码模板

### 1. API层调用RPC模板

#### 模板A：有返回值的RPC调用

```go
// 📋 步骤1：添加import
import (
    "api/internal/breaker"  // 添加这行
)

// 📋 步骤2：替换RPC调用
// 原始代码：
rpcResp, err := l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
    Field: req.Field,
})

// 熔断器代码：
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "service-name-rpc", func() (*client.Response, error) {
    return l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
        Field: req.Field,
    })
}, breaker.IsAcceptableError)
```

#### 模板B：无返回值的RPC调用

```go
// 原始代码：
_, err = l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
    Field: req.Field,
})

// 熔断器代码：
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "service-name-rpc", func() (*client.Response, error) {
    return l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
        Field: req.Field,
    })
}, breaker.IsAcceptableError)
```

### 2. RPC层调用其他RPC模板

```go
// 📋 步骤1：添加import
import (
    "rpc/internal/breaker"  // 添加这行
)

// 📋 步骤2：替换RPC调用
// 原始代码：
userResp, err := l.svcCtx.AppUserClient.GetUserById(l.ctx, &appuserclient.GetUserByIdReq{
    UserId: in.UserId,
})

// 熔断器代码：
userResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuserclient.GetUserInfoResp, error) {
    return l.svcCtx.AppUserClient.GetUserById(l.ctx, &appuserclient.GetUserByIdReq{
        UserId: in.UserId,
    })
}, breaker.IsAcceptableError)
```

### 3. 带重试的关键业务调用模板

```go
// 对于关键业务，添加重试机制
rpcResp, err := breaker.DoWithBreakerAndRetry(l.ctx, "service-name-rpc", func() (*client.Response, error) {
    return l.svcCtx.ServiceRpc.Method(l.ctx, &client.Request{
        Field: req.Field,
    })
}, 3, time.Second) // 最多重试3次，每次间隔1秒
```

## 🔄 具体模块实施指南

### AppUser模块

#### loginLogic.go ✅ 已完成
```go
// 参考已完成的实现
loginResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.LoginResp, error) {
    return l.svcCtx.AppUserRpc.Login(l.ctx, &appuser.LoginReq{
        Phone:    req.Phone,
        Password: req.Password,
    })
}, breaker.IsAcceptableError)
```

#### 其他Logic文件模板
```go
// getUserByPhoneLogic.go
userResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.GetUserInfoResp, error) {
    return l.svcCtx.AppUserRpc.GetUserByPhone(l.ctx, &appuser.GetUserInfoReq{
        Phone: req.Phone,
    })
}, breaker.IsAcceptableError)

// updateUserInfoLogic.go  
updateResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.UpdateUserInfoResp, error) {
    return l.svcCtx.AppUserRpc.UpdateUserInfo(l.ctx, &appuser.UpdateUserInfoReq{
        UserInfo: rpcUserInfo,
    })
}, breaker.IsAcceptableError)

// deleteUserLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.DeleteUserResp, error) {
    return l.svcCtx.AppUserRpc.DeleteUser(l.ctx, &appuser.DeleteUserReq{
        Phone: req.Phone,
    })
}, breaker.IsAcceptableError)

// changePasswordLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.ChangePasswordResp, error) {
    return l.svcCtx.AppUserRpc.ChangePassword(l.ctx, &appuser.ChangePasswordReq{
        Phone:       req.Phone,
        OldPassword: req.OldPassword,
        NewPassword: req.NewPassword,
    })
}, breaker.IsAcceptableError)

// logoutLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "appuser-rpc", func() (*appuser.LogoutResp, error) {
    return l.svcCtx.AppUserRpc.Logout(l.ctx, &appuser.LogoutReq{})
}, breaker.IsAcceptableError)
```

### OaUser模块

```go
// loginLogic.go
loginResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.LoginResp, error) {
    return l.svcCtx.OaUserRpc.Login(l.ctx, &oauserclient.LoginReq{
        Phone:    req.Phone,
        Password: req.Password,
    })
}, breaker.IsAcceptableError)

// registerLogic.go
registerResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.RegisterResp, error) {
    return l.svcCtx.OaUserRpc.Register(l.ctx, &oauserclient.RegisterReq{
        Phone:    req.Phone,
        Password: req.Password,
        Role:     req.Role,
    })
}, breaker.IsAcceptableError)

// getUserByPhoneLogic.go
getUserResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.GetUserInfoResp, error) {
    return l.svcCtx.OaUserRpc.GetUserByPhone(l.ctx, &oauserclient.GetUserInfoReq{
        Phone: req.Phone,
    })
}, breaker.IsAcceptableError)

// updateUserStatusLogic.go
updateResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "oauser-rpc", func() (*oauserclient.UpdateUserStatusResp, error) {
    return l.svcCtx.OaUserRpc.UpdateUserStatus(l.ctx, &oauserclient.UpdateUserStatusReq{
        Phone:  req.Phone,
        Status: int32(req.Status),
    })
}, breaker.IsAcceptableError)
```

### Loan模块

```go
// getMyLoanApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.GetLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.GetLoanApplication(l.ctx, &loanclient.GetLoanApplicationReq{
        ApplicationId: applicationId,
    })
}, breaker.IsAcceptableError)

// updateMyLoanApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.UpdateLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.UpdateLoanApplication(l.ctx, &loanclient.UpdateLoanApplicationReq{
        ApplicationId: req.ApplicationId,
        Amount:        req.Amount,
        Duration:      req.Duration,
        Purpose:       req.Purpose,
    })
}, breaker.IsAcceptableError)

// listMyLoanApplicationsLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.ListLoanApplicationsResp, error) {
    return l.svcCtx.LoanRpc.ListLoanApplications(l.ctx, &loanclient.ListLoanApplicationsReq{
        UserId: userId,
        Page:   req.Page,
        Size:   req.Size,
    })
}, breaker.IsAcceptableError)

// approveLoanApplicationLogic.go (管理员审批)
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "loan-rpc", func() (*loanclient.ApproveLoanApplicationResp, error) {
    return l.svcCtx.LoanRpc.ApproveLoanApplication(l.ctx, &loanclient.ApproveLoanApplicationReq{
        ApplicationId:    req.ApplicationId,
        AuditorId:        auditorId,
        AuditorName:      auditorName,
        Action:           req.Action,
        Suggestions:      req.Suggestions,
        ApprovedAmount:   req.ApprovedAmount,
        ApprovedDuration: req.ApprovedDuration,
        InterestRate:     req.InterestRate,
    })
}, breaker.IsAcceptableError)
```

### Lease模块

```go
// getMyLeaseApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "lease-rpc", func() (*leaseclient.GetLeaseApplicationResp, error) {
    return l.svcCtx.LeaseRpc.GetLeaseApplication(l.ctx, &leaseclient.GetLeaseApplicationReq{
        ApplicationId: applicationId,
    })
}, breaker.IsAcceptableError)

// updateMyLeaseApplicationLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "lease-rpc", func() (*leaseclient.UpdateLeaseApplicationResp, error) {
    return l.svcCtx.LeaseRpc.UpdateLeaseApplication(l.ctx, &leaseclient.UpdateLeaseApplicationReq{
        ApplicationId:   req.ApplicationId,
        Purpose:         req.Purpose,
        DeliveryAddress: req.DeliveryAddress,
        ContactPhone:    req.ContactPhone,
    })
}, breaker.IsAcceptableError)

// cancelMyLeaseApplicationLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "lease-rpc", func() (*leaseclient.CancelLeaseApplicationResp, error) {
    return l.svcCtx.LeaseRpc.CancelLeaseApplication(l.ctx, &leaseclient.CancelLeaseApplicationReq{
        ApplicationId: req.ApplicationId,
        Reason:        req.Reason,
    })
}, breaker.IsAcceptableError)
```

### LoanProduct模块

```go
// getLoanProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.GetLoanProductResp, error) {
    return l.svcCtx.LoanProductRpc.GetLoanProduct(l.ctx, &loanproduct.GetLoanProductReq{
        Id: id,
    })
}, breaker.IsAcceptableError)

// updateLoanProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.UpdateLoanProductResp, error) {
    return l.svcCtx.LoanProductRpc.UpdateLoanProduct(l.ctx, &loanproduct.UpdateLoanProductReq{
        Id:           id,
        ProductCode:  req.ProductCode,
        Name:         req.Name,
        Type:         req.Type,
        MaxAmount:    req.MaxAmount,
        MinAmount:    req.MinAmount,
        MaxDuration:  req.MaxDuration,
        MinDuration:  req.MinDuration,
        InterestRate: req.InterestRate,
        Description:  req.Description,
    })
}, breaker.IsAcceptableError)

// deleteLoanProductLogic.go
_, err = breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.DeleteLoanProductResp, error) {
    return l.svcCtx.LoanProductRpc.DeleteLoanProduct(l.ctx, &loanproduct.DeleteLoanProductReq{
        Id: id,
    })
}, breaker.IsAcceptableError)

// listLoanProductsLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "loanproduct-rpc", func() (*loanproduct.ListLoanProductsResp, error) {
    return l.svcCtx.LoanProductRpc.ListLoanProducts(l.ctx, &loanproduct.ListLoanProductsReq{
        Page:   req.Page,
        Size:   req.Size,
        Status: req.Status,
    })
}, breaker.IsAcceptableError)
```

### LeaseProduct模块

```go
// getLeaseProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "leaseproduct-rpc", func() (*leaseproductservice.GetLeaseProductResp, error) {
    return l.svcCtx.LeaseProductRpc.GetLeaseProduct(l.ctx, &leaseproductservice.GetLeaseProductReq{
        ProductCode: productCode,
    })
}, breaker.IsAcceptableError)

// createLeaseProductLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "leaseproduct-rpc", func() (*leaseproduct.CreateLeaseProductResp, error) {
    return l.svcCtx.LeaseProductRpc.CreateLeaseProduct(l.ctx, &leaseproduct.CreateLeaseProductReq{
        ProductCode:    req.ProductCode,
        Name:           req.Name,
        Type:           req.Type,
        Machinery:      req.Machinery,
        Brand:          req.Brand,
        Model:          req.Model,
        DailyRate:      req.DailyRate,
        Deposit:        req.Deposit,
        MaxDuration:    req.MaxDuration,
        MinDuration:    req.MinDuration,
        Description:    req.Description,
        InventoryCount: req.InventoryCount,
    })
}, breaker.IsAcceptableError)

// checkInventoryAvailabilityLogic.go
rpcResp, err := breaker.DoWithBreakerResultAcceptable(l.ctx, "leaseproduct-rpc", func() (*leaseproductservice.CheckInventoryAvailabilityResp, error) {
    return l.svcCtx.LeaseProductRpc.CheckInventoryAvailability(l.ctx, &leaseproductservice.CheckInventoryAvailabilityReq{
        ProductCode: req.ProductCode,
        Quantity:    req.Quantity,
        StartDate:   req.StartDate,
        EndDate:     req.EndDate,
    })
}, breaker.IsAcceptableError)
```

## 🔍 服务名称映射表

| API调用的RPC服务 | 熔断器服务名 |
|------------------|-------------|
| AppUserRpc | `"appuser-rpc"` |
| OaUserRpc | `"oauser-rpc"` |
| LoanRpc | `"loan-rpc"` |
| LeaseRpc | `"lease-rpc"` |
| LoanProductRpc | `"loanproduct-rpc"` |
| LeaseProductRpc | `"leaseproduct-rpc"` |

## ⚡ 快速替换脚本

可以使用以下sed命令快速替换：

```bash
# 替换简单的RPC调用
sed -i 's/l\.svcCtx\.ServiceRpc\.Method/breaker.DoWithBreakerResultAcceptable(l.ctx, "service-rpc", func() (*Response, error) { return l.svcCtx.ServiceRpc.Method/g' file.go

# 需要手动添加闭包结尾和错误处理
```

## 📝 实施检查清单

- [ ] 添加`"api/internal/breaker"`或`"rpc/internal/breaker"`导入
- [ ] 替换所有RPC调用为熔断器调用
- [ ] 确认服务名称正确映射
- [ ] 保持原有的错误处理逻辑
- [ ] 编译验证无语法错误
- [ ] 测试验证功能正常

## 🚨 注意事项

1. **返回值类型匹配**: 确保熔断器函数的返回值类型与原RPC调用一致
2. **错误处理**: 保持原有的错误处理逻辑
3. **上下文传递**: 确保正确传递context
4. **服务名称**: 使用正确的服务名称进行熔断器标识
5. **导入路径**: API层使用`"api/internal/breaker"`，RPC层使用`"rpc/internal/breaker"`