 # å¾®æœåŠ¡ä¾èµ–å¯åŠ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

åœ¨åŸºäºgo-zero + Consulçš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå½“æœåŠ¡Aä¾èµ–æœåŠ¡Bæ—¶ï¼Œå¦‚æœæœåŠ¡Bæœªå¯åŠ¨ï¼ˆæœªæ³¨å†Œåˆ°Consulï¼‰ï¼ŒæœåŠ¡Aå¯èƒ½åœ¨ä»¥ä¸‹åœºæ™¯ä¸­å¯åŠ¨å¤±è´¥ï¼š

### ğŸ” é—®é¢˜åŸå› 

1. **å®¢æˆ·ç«¯åˆå§‹åŒ–æ—¶ç«‹å³è¿æ¥**ï¼šgo-zeroçš„RPCå®¢æˆ·ç«¯é»˜è®¤åœ¨åˆ›å»ºæ—¶ä¼šå°è¯•åˆå§‹åŒ–è¿æ¥ï¼Œè‹¥æ­¤æ—¶æœåŠ¡Bæœªæ³¨å†Œï¼Œä¼šå¯¼è‡´è¿æ¥å¤±è´¥
2. **å¥åº·æ£€æŸ¥è§¦å‘å¤±è´¥**ï¼šå®¢æˆ·ç«¯å¯èƒ½é…ç½®äº†å¯åŠ¨æ—¶çš„å¥åº·æ£€æŸ¥ï¼Œè‹¥æœåŠ¡Bæœªæ³¨å†Œï¼Œå¥åº·æ£€æŸ¥å¤±è´¥ä¼šç›´æ¥å¯¼è‡´æœåŠ¡Aå¯åŠ¨å¤±è´¥
3. **æœåŠ¡å‘ç°è§£æå¤±è´¥**ï¼šConsulæœåŠ¡å‘ç°æ— æ³•è§£æåˆ°ç›®æ ‡æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯åˆå§‹åŒ–ä¼šæŠ›å‡ºå¼‚å¸¸

## è§£å†³æ–¹æ¡ˆ

### 1. å¯ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼ˆæ¨èï¼‰

**åŸç†**ï¼šå»¶è¿ŸRPCå®¢æˆ·ç«¯åˆå§‹åŒ–ï¼Œä»…åœ¨é¦–æ¬¡è°ƒç”¨æ—¶æ‰å°è¯•è¿æ¥ï¼Œé¿å…å¯åŠ¨æ—¶å› ä¾èµ–æœåŠ¡æœªå°±ç»ªè€Œå¤±è´¥ã€‚

#### é…ç½®ç¤ºä¾‹

```yaml
# app/auth/cmd/rpc/etc/authrpc.yaml
# Auth RPC æœåŠ¡é…ç½®
Name: authrpc.rpc
ListenOn: 0.0.0.0:20010

# ä¾èµ–æœåŠ¡é…ç½® - å¯ç”¨æ‡’åŠ è½½
AppUserRpc:
  Target: consul://consul.huinong.internal/appuserrpc.rpc
  Timeout: 10000  # 10ç§’è¶…æ—¶
  NonBlock: true  # éé˜»å¡æ¨¡å¼ï¼Œå¯åŠ¨æ—¶ä¸å¼ºåˆ¶è¿æ¥

OaUserRpc:
  Target: consul://consul.huinong.internal/oauserrpc.rpc
  Timeout: 10000
  NonBlock: true
```

#### ä»£ç å®ç°

```go
// app/auth/cmd/rpc/internal/config/config.go
package config

import (
    "github.com/zeromicro/go-zero/zrpc"
    "github.com/zeromicro/zero-contrib/zrpc/registry/consul"
)

type Config struct {
    zrpc.RpcServerConf
    
    // ä¾èµ–çš„RPCæœåŠ¡é…ç½®
    AppUserRpc zrpc.RpcClientConf `json:",optional"`
    OaUserRpc  zrpc.RpcClientConf `json:",optional"`
    
    // Consul æœåŠ¡æ³¨å†Œé…ç½®
    Consul consul.Conf
}
```

```go
// app/auth/cmd/rpc/internal/svc/servicecontext.go
package svc

import (
    "context"
    "time"
    
    "rpc/internal/config"
    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/zrpc"
    
    "github.com/HuinongFinancial-Microservices/app/appuser/cmd/rpc/appuserclient"
    "github.com/HuinongFinancial-Microservices/app/oauser/cmd/rpc/oauserclient"
)

type ServiceContext struct {
    Config     config.Config
    AppUserRpc appuserclient.AppUser
    OaUserRpc  oauserclient.OaUser
}

func NewServiceContext(c config.Config) *ServiceContext {
    return &ServiceContext{
        Config:     c,
        AppUserRpc: createAppUserRpcClient(c.AppUserRpc),
        OaUserRpc:  createOaUserRpcClient(c.OaUserRpc),
    }
}

// åˆ›å»ºAppUser RPCå®¢æˆ·ç«¯ - å¸¦å®¹é”™æœºåˆ¶
func createAppUserRpcClient(conf zrpc.RpcClientConf) appuserclient.AppUser {
    if conf.Target == "" {
        logx.Info("AppUser RPCæœªé…ç½®ï¼Œä½¿ç”¨ç©ºå®¢æˆ·ç«¯")
        return &emptyAppUserClient{}
    }
    
    // è®¾ç½®æ‡’åŠ è½½å’Œå®¹é”™å‚æ•°
    conf.NonBlock = true
    conf.Timeout = 10000 // 10ç§’è¶…æ—¶
    
    client, err := zrpc.NewClient(conf)
    if err != nil {
        logx.Errorf("åˆ›å»ºAppUser RPCå®¢æˆ·ç«¯å¤±è´¥: %v", err)
        return &emptyAppUserClient{}
    }
    
    return appuserclient.NewAppUser(client)
}

// åˆ›å»ºOaUser RPCå®¢æˆ·ç«¯ - å¸¦å®¹é”™æœºåˆ¶
func createOaUserRpcClient(conf zrpc.RpcClientConf) oauserclient.OaUser {
    if conf.Target == "" {
        logx.Info("OaUser RPCæœªé…ç½®ï¼Œä½¿ç”¨ç©ºå®¢æˆ·ç«¯")
        return &emptyOaUserClient{}
    }
    
    conf.NonBlock = true
    conf.Timeout = 10000
    
    client, err := zrpc.NewClient(conf)
    if err != nil {
        logx.Errorf("åˆ›å»ºOaUser RPCå®¢æˆ·ç«¯å¤±è´¥: %v", err)
        return &emptyOaUserClient{}
    }
    
    return oauserclient.NewOaUser(client)
}

// ç©ºå®¢æˆ·ç«¯å®ç° - é¿å…nilæŒ‡é’ˆå¼‚å¸¸
type emptyAppUserClient struct{}

func (c *emptyAppUserClient) GetUser(ctx context.Context, req *appuserclient.GetUserReq) (*appuserclient.GetUserResp, error) {
    return nil, errors.New("AppUseræœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
}

type emptyOaUserClient struct{}

func (c *emptyOaUserClient) GetUser(ctx context.Context, req *oauserclient.GetUserReq) (*oauserclient.GetUserResp, error) {
    return nil, errors.New("OaUseræœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
}
```

### 2. ä¸šåŠ¡å±‚é‡è¯•æœºåˆ¶

**åŸç†**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ·»åŠ é‡è¯•å’Œç†”æ–­æœºåˆ¶ï¼Œå½“ä¾èµ–æœåŠ¡ä¸´æ—¶ä¸å¯ç”¨æ—¶è‡ªåŠ¨é‡è¯•ã€‚

```go
// app/auth/cmd/rpc/internal/logic/loginlogic.go
package logic

import (
    "context"
    "time"
    
    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/core/retry"
)

func (l *LoginLogic) Login(req *auth.LoginReq) (*auth.LoginResp, error) {
    // éªŒè¯ç”¨æˆ· - å¸¦é‡è¯•æœºåˆ¶
    var userInfo *appuserclient.GetUserResp
    
    err := retry.Do(func() error {
        var err error
        userInfo, err = l.svcCtx.AppUserRpc.GetUser(l.ctx, &appuserclient.GetUserReq{
            Account: req.Account,
        })
        
        if err != nil {
            logx.Errorf("è°ƒç”¨AppUseræœåŠ¡å¤±è´¥: %v", err)
            return err
        }
        return nil
    },
        retry.Attempts(3),                    // é‡è¯•3æ¬¡
        retry.Delay(1*time.Second),          // æ¯æ¬¡é—´éš”1ç§’
        retry.DelayType(retry.FixedDelay),   // å›ºå®šé—´éš”
    )
    
    if err != nil {
        // ä¾èµ–æœåŠ¡ä¸å¯ç”¨ï¼Œè®°å½•æ—¥å¿—ä½†ä¸é˜»å¡ä¸»æµç¨‹
        logx.Errorf("AppUseræœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é™çº§é€»è¾‘: %v", err)
        return l.fallbackLogin(req)
    }
    
    // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
    return l.processLogin(req, userInfo)
}

// é™çº§å¤„ç†é€»è¾‘
func (l *LoginLogic) fallbackLogin(req *auth.LoginReq) (*auth.LoginResp, error) {
    // å®ç°é™çº§é€»è¾‘ï¼Œå¦‚ä½¿ç”¨ç¼“å­˜ã€è¿”å›é»˜è®¤å€¼ç­‰
    return &auth.LoginResp{
        Success: false,
        Message: "ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•",
    }, nil
}
```

### 3. Kubernetes InitContainer è§£å†³æ–¹æ¡ˆ

**åŸç†**ï¼šåœ¨K8sä¸­ä½¿ç”¨InitContainerç­‰å¾…ä¾èµ–æœåŠ¡å°±ç»ªåå†å¯åŠ¨ä¸»å®¹å™¨ã€‚

```yaml
# k8s/auth-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-rpc
  namespace: huinong
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth-rpc
  template:
    metadata:
      labels:
        app: auth-rpc
    spec:
      # ğŸ”‘ å…³é”®ï¼šInitContainer ç­‰å¾…ä¾èµ–æœåŠ¡
      initContainers:
      # ç­‰å¾…ConsulæœåŠ¡å¯ç”¨
      - name: wait-consul
        image: busybox:1.35
        command: ['sh', '-c']
        args:
          - |
            echo "ç­‰å¾…ConsulæœåŠ¡å¯ç”¨..."
            until nc -z consul.huinong.internal 8500; do
              echo "Consulæœªå°±ç»ªï¼Œç­‰å¾…5ç§’..."
              sleep 5
            done
            echo "Consulå·²å°±ç»ª"
      
      # ç­‰å¾…AppUser RPCæœåŠ¡æ³¨å†Œåˆ°Consul
      - name: wait-appuser-rpc
        image: registry.huinong.internal/huinong/consul-tools:latest
        command: ['sh', '-c']
        args:
          - |
            export CONSUL_HTTP_ADDR=consul.huinong.internal:8500
            export CONSUL_HTTP_TOKEN=331c00f9-bd87-2383-4394-548a0e66dea9
            
            echo "ç­‰å¾…AppUser RPCæœåŠ¡æ³¨å†Œåˆ°Consul..."
            while true; do
              # æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²æ³¨å†Œä¸”å¥åº·
              healthy_count=$(consul catalog service appuserrpc.rpc | jq -r '.[] | select(.Checks[].Status == "passing") | .ServiceName' | wc -l)
              if [ "$healthy_count" -gt 0 ]; then
                echo "AppUser RPCæœåŠ¡å·²å°±ç»ª"
                break
              fi
              echo "AppUser RPCæœåŠ¡æœªå°±ç»ªï¼Œç­‰å¾…10ç§’..."
              sleep 10
            done
      
      # ç­‰å¾…OaUser RPCæœåŠ¡æ³¨å†Œåˆ°Consul
      - name: wait-oauser-rpc
        image: registry.huinong.internal/huinong/consul-tools:latest
        command: ['sh', '-c']
        args:
          - |
            export CONSUL_HTTP_ADDR=consul.huinong.internal:8500
            export CONSUL_HTTP_TOKEN=331c00f9-bd87-2383-4394-548a0e66dea9
            
            echo "ç­‰å¾…OaUser RPCæœåŠ¡æ³¨å†Œåˆ°Consul..."
            while true; do
              healthy_count=$(consul catalog service oauserrpc.rpc | jq -r '.[] | select(.Checks[].Status == "passing") | .ServiceName' | wc -l)
              if [ "$healthy_count" -gt 0 ]; then
                echo "OaUser RPCæœåŠ¡å·²å°±ç»ª"
                break
              fi
              echo "OaUser RPCæœåŠ¡æœªå°±ç»ªï¼Œç­‰å¾…10ç§’..."
              sleep 10
            done
      
      containers:
      - name: auth-rpc
        image: registry.huinong.internal/huinong/auth-rpc:v1.0.0
        ports:
        - containerPort: 20010
        
        # å¥åº·æ£€æŸ¥ - ç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ
        livenessProbe:
          tcpSocket:
            port: 20010
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          tcpSocket:
            port: 20010
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # ä¼˜é›…å…³é—­
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      
      # é‡å¯ç­–ç•¥
      restartPolicy: Always
```

### 4. Consulå¥åº·æ£€æŸ¥é…ç½®

**åŸç†**ï¼šé…ç½®åˆç†çš„å¥åº·æ£€æŸ¥å‚æ•°ï¼Œé¿å…å› ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„æœåŠ¡å¼‚å¸¸ã€‚

```yaml
# app/auth/cmd/rpc/etc/authrpc.yaml
Name: authrpc.rpc
ListenOn: 0.0.0.0:20010

# Consul æœåŠ¡æ³¨å†Œé…ç½®
Consul:
  Host: consul.huinong.internal
  Key: authrpc.rpc
  Token: "331c00f9-bd87-2383-4394-548a0e66dea9"
  
  # å¥åº·æ£€æŸ¥é…ç½® - å…³é”®å‚æ•°
  Check:
    CheckInterval: "10s"        # å¥åº·æ£€æŸ¥é—´éš”
    CheckTimeout: "3s"          # å¥åº·æ£€æŸ¥è¶…æ—¶
    DeregisterCriticalServiceAfter: "30s"  # 30ç§’åæ³¨é”€ä¸å¥åº·æœåŠ¡
    
  # æ³¨å†Œé…ç½®
  Register:
    Tags: ["auth", "rpc", "v1.0.0"]
    Meta:
      version: "1.0.0"
      env: "production"
```

### 5. éƒ¨ç½²é¡ºåºæ§åˆ¶

**åŸç†**ï¼šé€šè¿‡åˆç†çš„éƒ¨ç½²é¡ºåºå’Œä¾èµ–ç®¡ç†ï¼Œç¡®ä¿åŸºç¡€æœåŠ¡ä¼˜å…ˆå¯åŠ¨ã€‚

```bash
#!/bin/bash
# scripts/deploy-order.sh - æœ‰åºéƒ¨ç½²è„šæœ¬

set -e

echo "å¼€å§‹æŒ‰ä¾èµ–é¡ºåºéƒ¨ç½²å¾®æœåŠ¡..."

# 1. éƒ¨ç½²åŸºç¡€æœåŠ¡ï¼ˆæ— ä¾èµ–ï¼‰
echo "1. éƒ¨ç½²åŸºç¡€æœåŠ¡..."
./scripts/docker.sh appuser deploy v1.0.0
./scripts/docker.sh oauser deploy v1.0.0

# ç­‰å¾…åŸºç¡€æœåŠ¡å°±ç»ª
echo "ç­‰å¾…åŸºç¡€æœåŠ¡å°±ç»ª..."
kubectl wait --for=condition=available --timeout=300s deployment/appuser-rpc deployment/oauser-rpc -n huinong

# 2. éƒ¨ç½²ä¾èµ–æœåŠ¡
echo "2. éƒ¨ç½²ä¾èµ–æœåŠ¡..."
./scripts/docker.sh auth deploy v1.0.0

# ç­‰å¾…ä¾èµ–æœåŠ¡å°±ç»ª
echo "ç­‰å¾…ä¾èµ–æœåŠ¡å°±ç»ª..."
kubectl wait --for=condition=available --timeout=300s deployment/auth-rpc -n huinong

# 3. éƒ¨ç½²ä¸šåŠ¡æœåŠ¡
echo "3. éƒ¨ç½²ä¸šåŠ¡æœåŠ¡..."
./scripts/docker.sh loan deploy v1.0.0
./scripts/docker.sh lease deploy v1.0.0

echo "æ‰€æœ‰æœåŠ¡éƒ¨ç½²å®Œæˆï¼"
```

## æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èåšæ³•

1. **æ‡’åŠ è½½å®¢æˆ·ç«¯**ï¼šé…ç½® `NonBlock: true`ï¼Œé¿å…å¯åŠ¨æ—¶å¼ºåˆ¶è¿æ¥
2. **ä¸šåŠ¡å±‚é‡è¯•**ï¼šä½¿ç”¨ `retry` åŒ…å®ç°è°ƒç”¨é‡è¯•å’Œç†”æ–­
3. **é™çº§å¤„ç†**ï¼šå½“ä¾èµ–æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œæä¾›åˆç†çš„é™çº§é€»è¾‘
4. **InitContainer**ï¼šåœ¨K8sä¸­ä½¿ç”¨InitContainerç­‰å¾…ä¾èµ–æœåŠ¡å°±ç»ª
5. **å¥åº·æ£€æŸ¥**ï¼šé…ç½®åˆç†çš„å¥åº·æ£€æŸ¥å‚æ•°ï¼Œé¿å…æœåŠ¡é¢‘ç¹æ³¨å†Œ/æ³¨é”€
6. **æœ‰åºéƒ¨ç½²**ï¼šæŒ‰ç…§ä¾èµ–å…³ç³»æœ‰åºéƒ¨ç½²æœåŠ¡

### âŒ é¿å…åšæ³•

1. **åŒæ­¥é˜»å¡åˆå§‹åŒ–**ï¼šé¿å…åœ¨æœåŠ¡å¯åŠ¨æ—¶åŒæ­¥åˆå§‹åŒ–æ‰€æœ‰RPCå®¢æˆ·ç«¯
2. **ç¡¬ä¾èµ–æ£€æŸ¥**ï¼šé¿å…åœ¨å¯åŠ¨æ—¶å¼ºåˆ¶æ£€æŸ¥æ‰€æœ‰ä¾èµ–æœåŠ¡å¯ç”¨æ€§
3. **æ— å®¹é”™æœºåˆ¶**ï¼šé¿å…ç¼ºå°‘é‡è¯•ã€ç†”æ–­ã€é™çº§ç­‰å®¹é”™æœºåˆ¶
4. **æ— åºéƒ¨ç½²**ï¼šé¿å…ä¸è€ƒè™‘ä¾èµ–å…³ç³»çš„éšæœºéƒ¨ç½²é¡ºåº

## æµ‹è¯•éªŒè¯

### 1. æ¨¡æ‹Ÿä¾èµ–æœåŠ¡å®•æœº

```bash
# åœæ­¢AppUseræœåŠ¡
kubectl scale deployment appuser-rpc --replicas=0 -n huinong

# æ£€æŸ¥AuthæœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
kubectl logs -f deployment/auth-rpc -n huinong

# åº”è¯¥çœ‹åˆ°é‡è¯•æ—¥å¿—ï¼Œä½†æœåŠ¡æ­£å¸¸è¿è¡Œ
```

### 2. éªŒè¯é‡è¯•æœºåˆ¶

```bash
# æµ‹è¯•AuthæœåŠ¡API
curl -X POST http://auth.huinong.internal/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"account": "test", "password": "123456"}'

# åº”è¯¥è¿”å›é™çº§å“åº”ï¼Œè€Œä¸æ˜¯é”™è¯¯
```

### 3. æ¢å¤ä¾èµ–æœåŠ¡

```bash
# æ¢å¤AppUseræœåŠ¡
kubectl scale deployment appuser-rpc --replicas=2 -n huinong

# ç­‰å¾…æœåŠ¡å°±ç»ª
kubectl wait --for=condition=available --timeout=300s deployment/appuser-rpc -n huinong

# å†æ¬¡æµ‹è¯•AuthæœåŠ¡APIï¼Œåº”è¯¥æ¢å¤æ­£å¸¸
```

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šè§£å†³æ–¹æ¡ˆçš„ç»„åˆä½¿ç”¨ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³å¾®æœåŠ¡ä¾èµ–å¯åŠ¨çš„é—®é¢˜ï¼š

1. **go-zeroé…ç½®å±‚é¢**ï¼šå¯ç”¨æ‡’åŠ è½½å’Œéé˜»å¡æ¨¡å¼
2. **ä»£ç å±‚é¢**ï¼šå®ç°é‡è¯•æœºåˆ¶å’Œé™çº§é€»è¾‘  
3. **éƒ¨ç½²å±‚é¢**ï¼šä½¿ç”¨InitContainerå’Œæœ‰åºéƒ¨ç½²
4. **ç›‘æ§å±‚é¢**ï¼šé…ç½®åˆç†çš„å¥åº·æ£€æŸ¥å‚æ•°

è¿™æ ·æ—¢ä¿è¯äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œåˆæä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚åœ¨K8sç¯å¢ƒä¸­ï¼Œè¿™äº›æœºåˆ¶å¯ä»¥è‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†ä¾èµ–é—®é¢˜ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚