# go-zero 用户缓存清理工具

## 问题描述

当您直接从数据库删除用户记录时，Redis缓存中可能仍然保留着旧数据，导致：

- 注册时提示"用户已存在"
- 登录时提示"密码错误"或"用户被禁用"
- API返回状态码500错误

## 缓存键格式

### AppUser（C端用户）
- ID缓存：`cache:appUsers:id:{用户ID}`
- 手机号缓存：`cache:appUsers:phone:{手机号}`

### OaUser（B端用户）
- ID缓存：`cache:oaUsers:id:{用户ID}`
- 手机号缓存：`cache:oaUsers:phone:{手机号}`

## 解决方案

### 1. 立即解决（推荐）

使用提供的清理脚本：

```bash
# 清理所有用户缓存（最彻底的方法）
./scripts/clear_user_cache.sh all

# 清理特定手机号的缓存
./scripts/clear_user_cache.sh phone 13452552490

# 清理特定用户ID的缓存
./scripts/clear_user_cache.sh id 1001

# 查看当前所有缓存键
./scripts/clear_user_cache.sh list

# 测试Redis连接
./scripts/clear_user_cache.sh test
```

### 2. 手动清理（直接使用Redis命令）

```bash
# 清理所有AppUser缓存
redis-cli --scan --pattern "cache:appUsers:*" | xargs redis-cli del

# 清理所有OaUser缓存
redis-cli --scan --pattern "cache:oaUsers:*" | xargs redis-cli del

# 清理特定手机号缓存
redis-cli del "cache:appUsers:phone:13452552490"
redis-cli del "cache:oaUsers:phone:13452552490"
```

## 配置修改

如果您的Redis配置与默认不同，请修改脚本中的配置：

```bash
# 在 scripts/clear_user_cache.sh 中修改这些变量
REDIS_HOST="127.0.0.1"    # Redis服务器地址
REDIS_PORT="6379"         # Redis端口
REDIS_DB="0"              # Redis数据库编号
```

## 预防措施

### 1. 使用Model的Delete方法

**错误做法：**
```sql
-- 直接删除数据库记录
DELETE FROM app_users WHERE phone = '13452552490';
```

**正确做法：**
```go
// 使用go-zero模型的Delete方法
user, err := userModel.FindOneByPhone(ctx, "13452552490")
if err != nil {
    return err
}
err = userModel.Delete(ctx, user.Id)
```

### 2. 添加自定义清理方法

在 `customAppUsersModel` 中添加清理方法：

```go
// 在 app/appuser/cmd/model/appUsersModel.go 中添加
func (m *customAppUsersModel) DeleteByPhone(ctx context.Context, phone string) error {
    user, err := m.FindOneByPhone(ctx, phone)
    if err != nil {
        return err
    }
    return m.Delete(ctx, user.Id)
}
```

### 3. 缓存配置优化

在配置文件中调整缓存过期时间：

```yaml
# 在 appuser.yaml 和 oauser.yaml 中添加
Cache:
  - Host: localhost:6379
    Type: redis
    # 设置较短的过期时间，避免长期不一致
    ExpireTime: 3600  # 1小时
```

## 故障排查

### 1. 检查Redis连接
```bash
./scripts/clear_user_cache.sh test
```

### 2. 查看当前缓存状态
```bash
./scripts/clear_user_cache.sh list
```

### 3. 检查服务日志
```bash
# 检查API服务日志
tail -f app/appuser/cmd/api/logs/access.log
tail -f app/oauser/cmd/api/logs/access.log

# 检查RPC服务日志
tail -f app/appuser/cmd/rpc/logs/access.log
tail -f app/oauser/cmd/rpc/logs/access.log
```

## 常见问题

### Q: 为什么清理缓存后还是有问题？
A: 可能原因：
1. Redis配置不正确
2. 多个Redis实例或数据库
3. 缓存键命名不匹配
4. 应用程序未重启

### Q: 生产环境是否安全？
A: 清理缓存是安全的，但建议：
1. 在维护窗口执行
2. 先备份重要数据
3. 通知相关业务人员

### Q: 如何避免以后出现此问题？
A: 
1. 始终使用Model的Delete方法
2. 不要直接操作数据库
3. 如必须直接操作，记得同步清理缓存
4. 设置合理的缓存过期时间

## 立即执行

基于您的测试日志，建议立即执行：

```bash
# 清理所有缓存（最彻底的解决方案）
./scripts/clear_user_cache.sh all

# 或者只清理问题用户的缓存
./scripts/clear_user_cache.sh phone 13452552490
./scripts/clear_user_cache.sh phone 13452552491
```

执行后重新运行您的测试脚本，问题应该得到解决。 