syntax = "proto3";

package lease;
import "google/protobuf/empty.proto";

option go_package = "./lease";

// 服务架构:
// 用户 -> 前端 -> nginx网关 -> lease-api -> lease.rpc -> redis 缓存租赁信息 -> 数据库 lease (MySQL)
//                                                     -> leaseproduct.rpc -> redis 缓存产品信息 -> 数据库 leaseproduct (MySQL)
//                                                     -> appuser.rpc -> redis 缓存用户信息 -> 数据库 appuser (MySQL)

// consul 注册地址:consul.huinong.internal
// rpc 端口:20004
// rpc 服务名:lease.rpc

// 数据库:lease (MySQL)
// 缓存:redis 缓存租赁申请信息

// 服务职责:
// 1. 租赁申请管理:租赁申请创建、查询、修改、撤销
// 2. 租赁审批管理:申请审批、审批记录查询

// -- ----------------------------
// 租赁申请表
// -- ----------------------------
// DROP TABLE IF EXISTS `lease_applications`;
// CREATE TABLE `lease_applications` (
//   `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '申请ID',
//   `application_id` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '申请编号',
//   `user_id` bigint UNSIGNED NOT NULL COMMENT '用户ID',
//   `applicant_name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '申请人姓名',
//   `product_id` bigint UNSIGNED NOT NULL COMMENT '租赁产品ID',
//   `product_code` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '产品编码',
//   `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '申请名称',
//   `type` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '租赁类型',
//   `machinery` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '设备名称',
//   `start_date` date NOT NULL COMMENT '开始日期',
//   `end_date` date NOT NULL COMMENT '结束日期',
//   `duration` int UNSIGNED NOT NULL COMMENT '租期(天)',
//   `daily_rate` decimal(10,2) NOT NULL COMMENT '日租金',
//   `total_amount` decimal(10,2) NOT NULL COMMENT '总金额',
//   `deposit` decimal(10,2) DEFAULT 0.00 COMMENT '押金',
//   `delivery_address` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '交付地址',
//   `contact_phone` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '联系电话',
//   `purpose` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '使用目的',
//   `status` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'pending' COMMENT '状态 pending/approved/rejected/cancelled',
//   `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
//   `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
//   PRIMARY KEY (`id`),
//   UNIQUE KEY `uk_application_id` (`application_id`),
//   KEY `idx_user_id` (`user_id`),
//   KEY `idx_product_id` (`product_id`),
//   KEY `idx_status` (`status`)
// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='租赁申请表';

// -- ----------------------------
// 租赁审批记录表
// -- ----------------------------
// DROP TABLE IF EXISTS `lease_approvals`;
// CREATE TABLE `lease_approvals` (
//   `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '审批ID',
//   `application_id` bigint UNSIGNED NOT NULL COMMENT '申请ID',
//   `auditor_id` bigint UNSIGNED NOT NULL COMMENT '审核员ID',
//   `auditor_name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '审核员姓名',
//   `action` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '审批动作 approve/reject',
//   `suggestions` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '审批意见',
//   `approved_duration` int UNSIGNED DEFAULT NULL COMMENT '批准租期(天)',
//   `approved_amount` decimal(10,2) DEFAULT NULL COMMENT '批准金额',
//   `approved_deposit` decimal(10,2) DEFAULT NULL COMMENT '批准押金',
//   `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
//   PRIMARY KEY (`id`),
//   KEY `idx_application_id` (`application_id`),
//   KEY `idx_auditor_id` (`auditor_id`),
//   KEY `idx_action` (`action`)
// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='租赁审批记录表';

// 租赁申请基础信息
message LeaseApplicationInfo {
  int64 id = 1;                     // 申请ID
  string application_id = 2;        // 申请编号
  int64 user_id = 3;                // 用户ID
  string applicant_name = 4;        // 申请人姓名
  int64 product_id = 5;             // 产品ID
  string product_code = 6;          // 产品编码
  string name = 7;                  // 申请名称
  string type = 8;                  // 租赁类型
  string machinery = 9;             // 设备名称
  string start_date = 10;           // 开始日期
  string end_date = 11;             // 结束日期
  int32 duration = 12;              // 租期(天)
  double daily_rate = 13;           // 日租金
  double total_amount = 14;         // 总金额
  double deposit = 15;              // 押金
  string delivery_address = 16;     // 交付地址
  string contact_phone = 17;        // 联系电话
  string purpose = 18;              // 使用目的
  string status = 19;               // 状态 pending/approved/rejected/cancelled
  int64 created_at = 20;            // 创建时间
  int64 updated_at = 21;            // 更新时间
}

// 租赁审批记录基础信息
message LeaseApprovalInfo {
  int64 id = 1;                     // 审批ID
  int64 application_id = 2;         // 申请ID
  int64 auditor_id = 3;             // 审核员ID
  string auditor_name = 4;          // 审核员姓名
  string action = 5;                // 审批动作 approve/reject
  string suggestions = 6;           // 审批意见
  int32 approved_duration = 7;      // 批准租期(天)
  double approved_amount = 8;       // 批准金额
  double approved_deposit = 9;      // 批准押金
  int64 created_at = 10;            // 创建时间
}

// 租赁合同信息
message LeaseContractInfo {
  int64 id = 1;                     // 合同ID
  int64 applicationId = 2;          // 申请ID
  string contractNo = 3;            // 合同编号
  int64 userId = 4;                 // 用户ID
  int64 productId = 5;              // 产品ID
  string productCode = 6;           // 产品编码
  string machinery = 7;             // 设备名称
  string startDate = 8;             // 开始日期
  string endDate = 9;               // 结束日期
  int32 duration = 10;              // 租期(天)
  double dailyRate = 11;            // 日租金
  double totalAmount = 12;          // 总金额
  double deposit = 13;              // 押金
  string deliveryAddress = 14;      // 交付地址
  string status = 15;               // 状态 active/completed/cancelled
  int64 createdAt = 16;             // 创建时间
  int64 updatedAt = 17;             // 更新时间
}

// 设备交付记录
message DeliveryRecord {
  int64 id = 1;                     // 记录ID
  int64 contract_id = 2;            // 合同ID
  string contract_no = 3;           // 合同编号
  string equipment_id = 4;          // 设备编号
  string delivery_type = 5;         // 交付类型
  string delivery_date = 6;         // 交付日期
  string delivery_address = 7;      // 交付地址
  string delivery_person = 8;       // 交付人员
  string receiver_name = 9;         // 接收人姓名
  string receiver_phone = 10;       // 接收人电话
  string equipment_condition = 11;  // 设备状况
  string photos = 12;               // 照片(JSON数组)
  string remarks = 13;              // 备注
  string status = 14;               // 状态
  int64 created_at = 15;            // 创建时间
  int64 updated_at = 16;            // 更新时间
}

// 租金记录
message RentalPayment {
  int64 id = 1;                     // 记录ID
  int64 contract_id = 2;            // 合同ID
  string contract_no = 3;           // 合同编号
  string payment_type = 4;          // 支付类型
  double amount = 5;                // 金额
  double paid_amount = 6;           // 已支付金额
  string due_date = 7;              // 到期日期
  string paid_date = 8;             // 支付日期
  string payment_method = 9;        // 支付方式
  string payment_order_no = 10;     // 支付订单号
  string status = 11;               // 状态
  string remarks = 12;              // 备注
  int64 created_at = 13;            // 创建时间
  int64 updated_at = 14;            // 更新时间
}

// Lease服务 - 包含租赁申请管理和审批管理
service Lease {
  // 租赁申请管理
  rpc CreateLeaseApplication(CreateLeaseApplicationReq) returns (CreateLeaseApplicationResp);
  rpc GetLeaseApplication(GetLeaseApplicationReq) returns (GetLeaseApplicationResp);
  rpc ListLeaseApplications(ListLeaseApplicationsReq) returns (ListLeaseApplicationsResp);
  rpc UpdateLeaseApplication(UpdateLeaseApplicationReq) returns (UpdateLeaseApplicationResp);
  rpc CancelLeaseApplication(CancelLeaseApplicationReq) returns (CancelLeaseApplicationResp);
  
  // 租赁审批管理
  rpc ApproveLeaseApplication(ApproveLeaseApplicationReq) returns (ApproveLeaseApplicationResp);
  rpc ListLeaseApprovals(ListLeaseApprovalsReq) returns (ListLeaseApprovalsResp);
}

// 创建租赁申请
message CreateLeaseApplicationReq {
  int64 user_id = 1;
  int64 product_id = 2;
  string product_code = 3;
  string name = 4;
  string type = 5;
  string machinery = 6;
  string start_date = 7;
  string end_date = 8;
  int32 duration = 9;
  double daily_rate = 10;
  double total_amount = 11;
  double deposit = 12;
  string delivery_address = 13;
  string contact_phone = 14;
  string purpose = 15;
}

message CreateLeaseApplicationResp {
  int32 code = 1;
  string message = 2;
  string application_id = 3;
}

// 获取租赁申请
message GetLeaseApplicationReq { 
  string application_id = 1; 
}

message GetLeaseApplicationResp {
  int32 code = 1;
  string message = 2;
  LeaseApplicationInfo application_info = 3;
}

// 获取租赁申请列表
message ListLeaseApplicationsReq {
  int32 page = 1;
  int32 size = 2;
  int64 user_id = 3;
  string product_code = 4;
  string status = 5;
}

message ListLeaseApplicationsResp {
  int32 code = 1;
  string message = 2;
  repeated LeaseApplicationInfo list = 3;
  int64 total = 4;
}

// 更新租赁申请
message UpdateLeaseApplicationReq {
  string application_id = 1;
  string purpose = 2;
  string delivery_address = 3;
  string contact_phone = 4;
}

message UpdateLeaseApplicationResp {
  int32 code = 1;
  string message = 2;
  LeaseApplicationInfo application_info = 3;
}

// 撤销租赁申请
message CancelLeaseApplicationReq {
  string application_id = 1;
  string reason = 2;
}

message CancelLeaseApplicationResp {
  int32 code = 1;
  string message = 2;
}

// 审批租赁申请
message ApproveLeaseApplicationReq {
  string application_id = 1;
  int64 auditor_id = 2;
  string auditor_name = 3;
  string action = 4; // approve/reject
  string suggestions = 5;
  int32 approved_duration = 6;
  double approved_amount = 7;
  double approved_deposit = 8;
}

message ApproveLeaseApplicationResp {
  int32 code = 1;
  string message = 2;
}

// 获取审批记录列表
message ListLeaseApprovalsReq {
  string application_id = 1;
}

message ListLeaseApprovalsResp {
  int32 code = 1;
  string message = 2;
  repeated LeaseApprovalInfo list = 3;
}

// === 服务请求/响应 ===

// --- 合同管理 ---
message CreateLeaseContractReq {
  int64 applicationId = 1;
}

message GetLeaseContractReq { 
  string contractNo = 1; 
}

message ListLeaseContractsReq {
  int32 page = 1;
  int32 size = 2;
  int64 userId = 3;
  string productCode = 4;
  string status = 5;
}
message ListLeaseContractsResp {
  repeated LeaseContractInfo list = 1;
  int64 total = 2;
}

message UpdateContractStatusReq {
  string contractNo = 1;
  string status = 2;
}

// --- 交付管理 ---
message CreateDeliveryRecordReq {
  int64 contract_id = 1;
  string equipment_id = 2;
  string delivery_type = 3;
  string delivery_date = 4;
  string delivery_address = 5;
  string delivery_person = 6;
  string receiver_name = 7;
  string receiver_phone = 8;
  string equipment_condition = 9;
  repeated string photos = 10;
  string remarks = 11;
}
message CreateDeliveryRecordResp { int64 id = 1; }

message UpdateDeliveryRecordReq {
  int64 id = 1;
  string equipment_condition = 2;
  repeated string photos = 3;
  string remarks = 4;
  string status = 5;
}

message ListDeliveryRecordsReq {
  int64 page = 1;
  int64 size = 2;
  int64 contract_id = 3;
  string equipment_id = 4;
  string delivery_type = 5;
  string status = 6;
}
message ListDeliveryRecordsResp {
  repeated DeliveryRecord list = 1;
  int64 total = 2;
}

// --- 租金管理 ---
message CreateRentalPaymentReq {
  int64 contract_id = 1;
  string payment_type = 2;
  double amount = 3;
  string due_date = 4;
  string remarks = 5;
}
message CreateRentalPaymentResp { int64 id = 1; }

message PayRentalReq {
  int64 payment_id = 1;
  string payment_method = 2;
  string payment_order_no = 3;
}

message ListRentalPaymentsReq {
  int64 page = 1;
  int64 size = 2;
  int64 contract_id = 3;
  string payment_type = 4;
  string status = 5;
}
message ListRentalPaymentsResp {
  repeated RentalPayment list = 1;
  int64 total = 2;
}

// === 服务定义 ===
service LeaseService {
  // 申请管理
  rpc CreateLeaseApplication(CreateLeaseApplicationReq) returns (LeaseApplicationInfo);
  rpc GetLeaseApplication(GetLeaseApplicationReq) returns (LeaseApplicationInfo);
  rpc ListLeaseApplications(ListLeaseApplicationsReq) returns (ListLeaseApplicationsResp);
  rpc UpdateLeaseApplication(UpdateLeaseApplicationReq) returns (LeaseApplicationInfo);
  rpc CancelLeaseApplication(CancelLeaseApplicationReq) returns (google.protobuf.Empty);
  
  // 审批管理
  rpc ApproveLeaseApplication(ApproveLeaseApplicationReq) returns (google.protobuf.Empty);
  rpc ListLeaseApprovals(ListLeaseApprovalsReq) returns (ListLeaseApprovalsResp);
  
  // 合同管理
  rpc CreateLeaseContract(CreateLeaseContractReq) returns (LeaseContractInfo);
  rpc GetLeaseContract(GetLeaseContractReq) returns (LeaseContractInfo);
  rpc ListLeaseContracts(ListLeaseContractsReq) returns (ListLeaseContractsResp);
  rpc UpdateContractStatus(UpdateContractStatusReq) returns (google.protobuf.Empty);
  
  // 交付管理
  rpc CreateDeliveryRecord(CreateDeliveryRecordReq) returns (CreateDeliveryRecordResp);
  rpc UpdateDeliveryRecord(UpdateDeliveryRecordReq) returns (google.protobuf.Empty);
  rpc ListDeliveryRecords(ListDeliveryRecordsReq) returns (ListDeliveryRecordsResp);
  
  // 租金管理
  rpc CreateRentalPayment(CreateRentalPaymentReq) returns (CreateRentalPaymentResp);
  rpc PayRental(PayRentalReq) returns (google.protobuf.Empty);
  rpc ListRentalPayments(ListRentalPaymentsReq) returns (ListRentalPaymentsResp);
} 