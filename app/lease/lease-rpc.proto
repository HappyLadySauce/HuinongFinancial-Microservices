syntax = "proto3";

package lease;
import "google/protobuf/empty.proto";

option go_package = "./lease";

// 服务架构:
// 用户 -> 前端 -> nginx网关 -> lease-api -> lease.rpc -> redis 缓存租赁信息 -> 数据库 lease (MySQL)
//                                                     -> leaseproduct.rpc -> redis 缓存产品信息 -> 数据库 leaseproduct (MySQL)
//                                                     -> appuser.rpc -> redis 缓存用户信息 -> 数据库 appuser (MySQL)

// consul 注册地址:consul.huinong.internal
// rpc 端口:20004
// rpc 服务名:lease.rpc

// 数据库:lease (MySQL)
// 缓存:redis 缓存租赁申请信息

// 服务职责:
// 1. 租赁申请管理:租赁申请创建、查询、修改、撤销
// 2. 租赁审批管理:申请审批、审批记录查询

// -- ----------------------------
// 租赁申请表
// -- ----------------------------
// DROP TABLE IF EXISTS `lease_applications`;
// CREATE TABLE `lease_applications` (
//   `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '申请ID',
//   `application_id` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '申请编号',
//   `user_id` bigint UNSIGNED NOT NULL COMMENT '用户ID',
//   `applicant_name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '申请人姓名',
//   `product_id` bigint UNSIGNED NOT NULL COMMENT '租赁产品ID',
//   `product_code` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '产品编码',
//   `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '申请名称',
//   `type` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '租赁类型',
//   `machinery` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '设备名称',
//   `start_date` date NOT NULL COMMENT '开始日期',
//   `end_date` date NOT NULL COMMENT '结束日期',
//   `duration` int UNSIGNED NOT NULL COMMENT '租期(天)',
//   `daily_rate` decimal(10,2) NOT NULL COMMENT '日租金',
//   `total_amount` decimal(10,2) NOT NULL COMMENT '总金额',
//   `deposit` decimal(10,2) DEFAULT 0.00 COMMENT '押金',
//   `delivery_address` varchar(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '交付地址',
//   `contact_phone` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '联系电话',
//   `purpose` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '使用目的',
//   `status` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'pending' COMMENT '状态 pending/approved/rejected/cancelled',
//   `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
//   `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
//   PRIMARY KEY (`id`),
//   UNIQUE KEY `uk_application_id` (`application_id`),
//   KEY `idx_user_id` (`user_id`),
//   KEY `idx_product_id` (`product_id`),
//   KEY `idx_status` (`status`)
// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='租赁申请表';

// -- ----------------------------
// 租赁审批记录表
// -- ----------------------------
// DROP TABLE IF EXISTS `lease_approvals`;
// CREATE TABLE `lease_approvals` (
//   `id` bigint UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '审批ID',
//   `application_id` bigint UNSIGNED NOT NULL COMMENT '申请ID',
//   `auditor_id` bigint UNSIGNED NOT NULL COMMENT '审核员ID',
//   `auditor_name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '审核员姓名',
//   `action` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '审批动作 approve/reject',
//   `suggestions` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci COMMENT '审批意见',
//   `approved_duration` int UNSIGNED DEFAULT NULL COMMENT '批准租期(天)',
//   `approved_amount` decimal(10,2) DEFAULT NULL COMMENT '批准金额',
//   `approved_deposit` decimal(10,2) DEFAULT NULL COMMENT '批准押金',
//   `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
//   PRIMARY KEY (`id`),
//   KEY `idx_application_id` (`application_id`),
//   KEY `idx_auditor_id` (`auditor_id`),
//   KEY `idx_action` (`action`)
// ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='租赁审批记录表';

// 租赁申请基础信息
message LeaseApplicationInfo {
  int64 id = 1;                     // 申请ID
  string application_id = 2;        // 申请编号
  int64 user_id = 3;                // 用户ID
  string applicant_name = 4;        // 申请人姓名
  int64 product_id = 5;             // 产品ID
  string product_code = 6;          // 产品编码
  string name = 7;                  // 申请名称
  string type = 8;                  // 租赁类型
  string machinery = 9;             // 设备名称
  string start_date = 10;           // 开始日期
  string end_date = 11;             // 结束日期
  int32 duration = 12;              // 租期(天)
  double daily_rate = 13;           // 日租金
  double total_amount = 14;         // 总金额
  double deposit = 15;              // 押金
  string delivery_address = 16;     // 交付地址
  string contact_phone = 17;        // 联系电话
  string purpose = 18;              // 使用目的
  string status = 19;               // 状态 pending/approved/rejected/cancelled
  int64 created_at = 20;            // 创建时间
  int64 updated_at = 21;            // 更新时间
}

// 租赁审批记录基础信息
message LeaseApprovalInfo {
  int64 id = 1;                     // 审批ID
  int64 application_id = 2;         // 申请ID
  int64 auditor_id = 3;             // 审核员ID
  string auditor_name = 4;          // 审核员姓名
  string action = 5;                // 审批动作 approve/reject
  string suggestions = 6;           // 审批意见
  int32 approved_duration = 7;      // 批准租期(天)
  double approved_amount = 8;       // 批准金额
  double approved_deposit = 9;      // 批准押金
  int64 created_at = 10;            // 创建时间
}



// Lease服务 - 包含租赁申请管理和审批管理
service Lease {
  // 健康检查
  rpc Ping(PingReq) returns (PingResp);
  
  // 租赁申请管理
  rpc CreateLeaseApplication(CreateLeaseApplicationReq) returns (CreateLeaseApplicationResp);
  rpc GetLeaseApplication(GetLeaseApplicationReq) returns (GetLeaseApplicationResp);
  rpc ListLeaseApplications(ListLeaseApplicationsReq) returns (ListLeaseApplicationsResp);
  rpc UpdateLeaseApplication(UpdateLeaseApplicationReq) returns (UpdateLeaseApplicationResp);
  rpc CancelLeaseApplication(CancelLeaseApplicationReq) returns (CancelLeaseApplicationResp);
  
  // 租赁审批管理
  rpc ApproveLeaseApplication(ApproveLeaseApplicationReq) returns (ApproveLeaseApplicationResp);
  rpc ListLeaseApprovals(ListLeaseApprovalsReq) returns (ListLeaseApprovalsResp);
}

// 创建租赁申请
message CreateLeaseApplicationReq {
  int64 user_id = 1;
  int64 product_id = 2;
  string product_code = 3;
  string name = 4;
  string type = 5;
  string machinery = 6;
  string start_date = 7;
  string end_date = 8;
  int32 duration = 9;
  double daily_rate = 10;
  double total_amount = 11;
  double deposit = 12;
  string delivery_address = 13;
  string contact_phone = 14;
  string purpose = 15;
}

message CreateLeaseApplicationResp {
  string application_id = 1;
}

// 获取租赁申请
message GetLeaseApplicationReq { 
  string application_id = 1; 
}

message GetLeaseApplicationResp {
  LeaseApplicationInfo application_info = 1;
}

// 获取租赁申请列表
message ListLeaseApplicationsReq {
  int32 page = 1;
  int32 size = 2;
  int64 user_id = 3;
  string product_code = 4;
  string status = 5;
}

message ListLeaseApplicationsResp {
  repeated LeaseApplicationInfo list = 1;
  int64 total = 2;
}

// 更新租赁申请
message UpdateLeaseApplicationReq {
  string application_id = 1;
  string purpose = 2;
  string delivery_address = 3;
  string contact_phone = 4;
}

message UpdateLeaseApplicationResp {
  LeaseApplicationInfo application_info = 1;
}

// 撤销租赁申请
message CancelLeaseApplicationReq {
  string application_id = 1;
  string reason = 2;
}

message CancelLeaseApplicationResp {
}

// 审批租赁申请
message ApproveLeaseApplicationReq {
  string application_id = 1;
  int64 auditor_id = 2;
  string auditor_name = 3;
  string action = 4; // approve/reject
  string suggestions = 5;
  int32 approved_duration = 6;
  double approved_amount = 7;
  double approved_deposit = 8;
}

message ApproveLeaseApplicationResp {
}

// 获取审批记录列表
message ListLeaseApprovalsReq {
  string application_id = 1;
}

message ListLeaseApprovalsResp {
  repeated LeaseApprovalInfo list = 1;
}

// 健康检查
message PingReq {
}

message PingResp {
    string status = 1; // 服务状态
}
// 健康检查

// goctl rpc protoc *.proto --go_out=../ --go-grpc_out=../  --zrpc_out=../
// sed -i "" 's/,omitempty//g' *.pb.go