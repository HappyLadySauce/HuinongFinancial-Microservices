# ğŸš€ è·¨æœåŠ¡è°ƒç”¨æ¶æ„è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

åŸºäºgo-zeroå¾®æœåŠ¡æ¶æ„çš„RPCé—´è·¨æœåŠ¡è°ƒç”¨è®¾è®¡ï¼Œé€šè¿‡consulæœåŠ¡å‘ç°å®ç°æœåŠ¡é—´é€šä¿¡ã€‚

## ğŸ—ï¸ æœåŠ¡æ¶æ„

### **æœåŠ¡å‘ç°æ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Consulé›†ç¾¤    â”‚    â”‚   Consulé›†ç¾¤    â”‚    â”‚   Consulé›†ç¾¤    â”‚
â”‚ consul.huinong â”‚â”€â”€â”€â”€â”‚ consul.huinong â”‚â”€â”€â”€â”€â”‚ consul.huinong â”‚
â”‚   .internal    â”‚    â”‚   .internal    â”‚    â”‚   .internal    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  æœåŠ¡æ³¨å†Œä¸­å¿ƒ                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AppUser RPC   â”‚    â”‚   Lease RPC     â”‚    â”‚   Loan RPC      â”‚
â”‚   ç«¯å£: 20001    â”‚    â”‚   ç«¯å£: 20004    â”‚    â”‚   ç«¯å£: 20002    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LeaseProduct RPC â”‚    â”‚LoanProduct RPC  â”‚    â”‚   OAUser RPC    â”‚
â”‚   ç«¯å£: 20006    â”‚    â”‚   ç«¯å£: 20005    â”‚    â”‚   ç«¯å£: 20003    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **æœåŠ¡ä¾èµ–å…³ç³»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è°ƒç”¨    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lease RPC  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ AppUser RPC â”‚
â”‚             â”‚         â”‚             â”‚
â”‚             â”‚    è°ƒç”¨    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚LeaseProduct â”‚
â”‚             â”‚         â”‚    RPC      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è°ƒç”¨    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Loan RPC   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ AppUser RPC â”‚
â”‚             â”‚         â”‚             â”‚
â”‚             â”‚    è°ƒç”¨    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚LoanProduct  â”‚
â”‚             â”‚         â”‚    RPC      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ è·¨æœåŠ¡è°ƒç”¨æ¥å£è®¾è®¡

### **1. AppUser RPC - ç”¨æˆ·æœåŠ¡**

#### **æœåŠ¡é…ç½®**
```yaml
Name: appuser.rpc
ListenOn: 0.0.0.0:20001
Etcd:
  Hosts:
    - consul.huinong.internal:2379
  Key: appuser.rpc
```

#### **æ ¸å¿ƒæ¥å£**
```protobuf
service AppUser {
    // é€šè¿‡æ‰‹æœºå·è·å–ç”¨æˆ·ä¿¡æ¯
    rpc GetUserByPhone(GetUserInfoReq) returns (GetUserInfoResp);
    
    // é€šè¿‡ç”¨æˆ·IDè·å–ç”¨æˆ·ä¿¡æ¯ (æ–°å¢ - ç”¨äºè·¨æœåŠ¡è°ƒç”¨)
    rpc GetUserById(GetUserByIdReq) returns (GetUserInfoResp);
    
    // å…¶ä»–è®¤è¯ç®¡ç†æ¥å£...
}

// é€šè¿‡ç”¨æˆ·IDè·å–ç”¨æˆ·ä¿¡æ¯ - æ–°å¢æ¥å£
message GetUserByIdReq {
    int64 user_id = 1;
}

message GetUserInfoResp {
    int32 code = 1;
    string message = 2;
    UserInfo user_info = 3;  // åŒ…å«nameå­—æ®µç”¨äºè·å–ç”¨æˆ·å§“å
}
```

### **2. LeaseProduct RPC - ç§Ÿèµäº§å“æœåŠ¡**

#### **æœåŠ¡é…ç½®**
```yaml
Name: leaseproductrpc.rpc
ListenOn: 0.0.0.0:20006
Etcd:
  Hosts:
    - consul.huinong.internal:2379
  Key: leaseproductrpc.rpc
```

#### **æ ¸å¿ƒæ¥å£**
```protobuf
service LeaseProductService {
    // äº§å“ä¿¡æ¯æŸ¥è¯¢
    rpc GetLeaseProduct(GetLeaseProductReq) returns (GetLeaseProductResp);
    
    // åº“å­˜å¯ç”¨æ€§æ£€æŸ¥ (å…³é”®æ¥å£)
    rpc CheckInventoryAvailability(CheckInventoryAvailabilityReq) returns (CheckInventoryAvailabilityResp);
}

message CheckInventoryAvailabilityReq {
    string productCode = 1;     // äº§å“ç¼–ç 
    int32 quantity = 2;         // éœ€è¦æ•°é‡
    string startDate = 3;       // å¼€å§‹æ—¥æœŸ
    string endDate = 4;         // ç»“æŸæ—¥æœŸ
}

message CheckInventoryAvailabilityResp {
    int32 code = 1;
    string message = 2;
    bool available = 3;         // æ˜¯å¦å¯ç”¨
    int32 availableCount = 4;   // å¯ç”¨æ•°é‡
}
```

### **3. LoanProduct RPC - è´·æ¬¾äº§å“æœåŠ¡**

#### **æœåŠ¡é…ç½®**
```yaml
Name: loanproductrpc.rpc
ListenOn: 0.0.0.0:20005
Etcd:
  Hosts:
    - consul.huinong.internal:2379
  Key: loanproductrpc.rpc
```

#### **æ ¸å¿ƒæ¥å£**
```protobuf
service LoanProductService {
    // é€šè¿‡IDæˆ–äº§å“ç¼–ç è·å–äº§å“ä¿¡æ¯
    rpc GetLoanProduct(GetLoanProductReq) returns (GetLoanProductResp);
}

message GetLoanProductReq {
    int64 id = 1;               // äº§å“ID (å¯é€‰)
    string productCode = 2;     // äº§å“ç¼–ç  (å¯é€‰)
}
```

## ğŸ”— è·¨æœåŠ¡è°ƒç”¨å®ç°

### **1. Lease RPC è·¨æœåŠ¡è°ƒç”¨**

#### **é…ç½®æ–‡ä»¶ (lease-rpc.yaml)**
```yaml
Name: lease.rpc
ListenOn: 0.0.0.0:20004
Etcd:
  Hosts:
    - consul.huinong.internal:2379
  Key: lease.rpc

# RPCå®¢æˆ·ç«¯é…ç½®
LeaseProductRpc:
  Etcd:
    Hosts:
      - consul.huinong.internal:2379
    Key: leaseproductrpc.rpc
    
AppUserRpc:
  Etcd:
    Hosts:
      - consul.huinong.internal:2379
    Key: appuser.rpc
```

#### **ServiceContexté…ç½®**
```go
type ServiceContext struct {
    Config                 config.Config
    LeaseApplicationsModel model.LeaseApplicationsModel
    LeaseApprovalsModel    model.LeaseApprovalsModel
    
    // RPC å®¢æˆ·ç«¯
    LeaseProductRpc leaseproduct.LeaseProductService  // å¾…ç”Ÿæˆ
    AppUserRpc      appuser.AppUserService           // å¾…ç”Ÿæˆ
}

func NewServiceContext(c config.Config) *ServiceContext {
    return &ServiceContext{
        Config: c,
        // ... å…¶ä»–é…ç½®
        
        // åˆå§‹åŒ–RPCå®¢æˆ·ç«¯
        LeaseProductRpc: leaseproduct.NewLeaseProductService(zrpc.MustNewClient(c.LeaseProductRpc)),
        AppUserRpc:      appuser.NewAppUserService(zrpc.MustNewClient(c.AppUserRpc)),
    }
}
```

#### **ä¸šåŠ¡é€»è¾‘è°ƒç”¨ç¤ºä¾‹**
```go
func (l *CreateLeaseApplicationLogic) CreateLeaseApplication(in *lease.CreateLeaseApplicationReq) (*lease.CreateLeaseApplicationResp, error) {
    // 1. éªŒè¯ç”¨æˆ·ä¿¡æ¯
    userResp, err := l.svcCtx.AppUserRpc.GetUserById(l.ctx, &appuser.GetUserByIdReq{
        UserId: in.UserId,
    })
    if err != nil || userResp.Code != 200 {
        return &lease.CreateLeaseApplicationResp{
            Code:    400,
            Message: "ç”¨æˆ·ä¿¡æ¯éªŒè¯å¤±è´¥",
        }, nil
    }
    
    // 2. æ£€æŸ¥äº§å“åº“å­˜
    stockResp, err := l.svcCtx.LeaseProductRpc.CheckInventoryAvailability(l.ctx, &leaseproduct.CheckInventoryAvailabilityReq{
        ProductCode: in.ProductCode,
        Quantity:    1,
        StartDate:   in.StartDate,
        EndDate:     in.EndDate,
    })
    if err != nil || stockResp.Code != 200 || !stockResp.Available {
        return &lease.CreateLeaseApplicationResp{
            Code:    400,
            Message: "äº§å“åº“å­˜ä¸è¶³æˆ–æ—¶é—´æ®µä¸å¯ç”¨",
        }, nil
    }
    
    // 3. åˆ›å»ºç”³è¯·è®°å½•
    applicantName := userResp.UserInfo.Name
    // ... åˆ›å»ºé€»è¾‘
}
```

### **2. Loan RPC è·¨æœåŠ¡è°ƒç”¨**

#### **é…ç½®æ–‡ä»¶ (loan-rpc.yaml)**
```yaml
Name: loan.rpc
ListenOn: 0.0.0.0:20002
Etcd:
  Hosts:
    - consul.huinong.internal:2379
  Key: loan.rpc

# RPCå®¢æˆ·ç«¯é…ç½®
LoanProductRpc:
  Etcd:
    Hosts:
      - consul.huinong.internal:2379
    Key: loanproductrpc.rpc
    
AppUserRpc:
  Etcd:
    Hosts:
      - consul.huinong.internal:2379
    Key: appuser.rpc
```

#### **ä¸šåŠ¡é€»è¾‘è°ƒç”¨ç¤ºä¾‹**
```go
func (l *CreateLoanApplicationLogic) CreateLoanApplication(in *loan.CreateLoanApplicationReq) (*loan.CreateLoanApplicationResp, error) {
    // 1. éªŒè¯ç”¨æˆ·ä¿¡æ¯
    userResp, err := l.svcCtx.AppUserRpc.GetUserById(l.ctx, &appuser.GetUserByIdReq{
        UserId: in.UserId,
    })
    if err != nil || userResp.Code != 200 {
        return &loan.CreateLoanApplicationResp{
            Code:    400,
            Message: "ç”¨æˆ·ä¿¡æ¯éªŒè¯å¤±è´¥",
        }, nil
    }
    
    // 2. éªŒè¯è´·æ¬¾äº§å“ä¿¡æ¯
    productResp, err := l.svcCtx.LoanProductRpc.GetLoanProduct(l.ctx, &loanproduct.GetLoanProductReq{
        Id: in.ProductId,
    })
    if err != nil || productResp.Code != 200 {
        return &loan.CreateLoanApplicationResp{
            Code:    400,
            Message: "è´·æ¬¾äº§å“ä¿¡æ¯éªŒè¯å¤±è´¥",
        }, nil
    }
    
    // 3. éªŒè¯ç”³è¯·é‡‘é¢æ˜¯å¦åœ¨äº§å“é™é¢å†…
    product := productResp.Data
    if in.Amount < product.MinAmount || in.Amount > product.MaxAmount {
        return &loan.CreateLoanApplicationResp{
            Code:    400,
            Message: "ç”³è¯·é‡‘é¢è¶…å‡ºäº§å“é™é¢",
        }, nil
    }
    
    // 4. åˆ›å»ºç”³è¯·è®°å½•
    applicantName := userResp.UserInfo.Name
    // ... åˆ›å»ºé€»è¾‘
}
```

## ğŸ“‹ å½“å‰è¿›åº¦

### **âœ… å·²å®Œæˆ**
1. **Protoæ¥å£å®šä¹‰** - æ‰€æœ‰æœåŠ¡çš„protoæ–‡ä»¶å·²å®Œå–„
2. **é…ç½®æ¶æ„** - ServiceContextå’ŒConfigç»“æ„å·²å°±ç»ª
3. **åŸºç¡€ä¸šåŠ¡é€»è¾‘** - æ ¸å¿ƒCRUDæ“ä½œå·²å®ç°
4. **æ•°æ®æ¨¡å‹** - æ‰€æœ‰è‡ªå®šä¹‰æ¨¡å‹æ–¹æ³•å·²æ·»åŠ 

### **ğŸ”„ è¿›è¡Œä¸­**
1. **ä»£ç é‡æ–°ç”Ÿæˆ** - æ­£åœ¨é‡æ–°ç”Ÿæˆæ‰€æœ‰RPCä»£ç 
2. **RPCå®¢æˆ·ç«¯æ¥å£** - ç­‰å¾…ç”Ÿæˆçš„å®¢æˆ·ç«¯æ¥å£

### **ğŸ“‹ å¾…å®Œæˆ**
1. **çœŸæ­£çš„è·¨æœåŠ¡è°ƒç”¨** - æ›¿æ¢å½“å‰çš„ä¸´æ—¶å®ç°
2. **é”™è¯¯å¤„ç†ä¼˜åŒ–** - å®Œå–„RPCè°ƒç”¨çš„é”™è¯¯å¤„ç†
3. **é…ç½®æ–‡ä»¶å®Œå–„** - æ·»åŠ å®é™…çš„æœåŠ¡å‘ç°é…ç½®
4. **é›†æˆæµ‹è¯•** - éªŒè¯è·¨æœåŠ¡è°ƒç”¨çš„æ­£ç¡®æ€§

## ğŸ¯ å®ç°è¦ç‚¹

### **1. æœåŠ¡å‘ç°**
- æ‰€æœ‰æœåŠ¡é€šè¿‡consulæ³¨å†Œå’Œå‘ç°
- ä½¿ç”¨go-zeroçš„zrpcå®¢æˆ·ç«¯è‡ªåŠ¨è´Ÿè½½å‡è¡¡
- æœåŠ¡å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»

### **2. é”™è¯¯å¤„ç†**
```go
// ç»Ÿä¸€çš„RPCè°ƒç”¨é”™è¯¯å¤„ç†
func callRemoteService(ctx context.Context, serviceName string, method func() error) error {
    if err := method(); err != nil {
        logx.Errorf("è°ƒç”¨%sæœåŠ¡å¤±è´¥: %v", serviceName, err)
        return fmt.Errorf("%sæœåŠ¡æš‚æ—¶ä¸å¯ç”¨", serviceName)
    }
    return nil
}
```

### **3. è¶…æ—¶æ§åˆ¶**
```go
// è®¾ç½®RPCè°ƒç”¨è¶…æ—¶
ctx, cancel := context.WithTimeout(l.ctx, 5*time.Second)
defer cancel()

userResp, err := l.svcCtx.AppUserRpc.GetUserById(ctx, req)
```

### **4. é‡è¯•æœºåˆ¶**
```go
// ä½¿ç”¨go-zeroçš„é‡è¯•ä¸­é—´ä»¶
AppUserRpc: zrpc.MustNewClient(c.AppUserRpc, 
    zrpc.WithRetry(retry.DoOnFailure(
        retry.Attempts(3),
        retry.Delay(100*time.Millisecond),
    )),
)
```

---

## ğŸŒŸ æ€»ç»“

è¿™ä¸ªè·¨æœåŠ¡è°ƒç”¨æ¶æ„æä¾›äº†ï¼š

1. **ğŸ—ï¸ æ ‡å‡†åŒ–æ¶æ„** - åŸºäºgo-zeroå’Œconsulçš„æ ‡å‡†å¾®æœåŠ¡æ¶æ„
2. **ğŸš€ é«˜æ€§èƒ½** - gRPCåè®®å’Œè¿æ¥æ± ä¼˜åŒ–
3. **ğŸ›¡ï¸ é«˜å¯ç”¨** - æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»
4. **ğŸ”§ æ˜“æ‰©å±•** - æ¸…æ™°çš„æ¥å£å®šä¹‰å’Œç»Ÿä¸€çš„è°ƒç”¨æ¨¡å¼
5. **ğŸ“Š å¯è§‚æµ‹** - å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œé”™è¯¯è¿½è¸ª

å¾…ä»£ç é‡æ–°ç”Ÿæˆå®Œæˆåï¼Œæˆ‘ä»¬å°†å®ç°çœŸæ­£çš„è·¨æœåŠ¡è°ƒç”¨é€»è¾‘ï¼Œæ›¿æ¢å½“å‰çš„ä¸´æ—¶å®ç°ã€‚

---

*æ­¤æ–‡æ¡£å±•ç¤ºäº†å®Œæ•´çš„è·¨æœåŠ¡è°ƒç”¨æ¶æ„è®¾è®¡ï¼Œä¸ºå¾®æœåŠ¡é—´é€šä¿¡æä¾›äº†æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚* 